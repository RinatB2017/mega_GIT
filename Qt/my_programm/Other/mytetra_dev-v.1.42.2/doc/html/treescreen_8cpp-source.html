<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mytetra: treescreen.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>treescreen.cpp</h1><a href="treescreen_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;QtGui/qabstractitemview.h&gt;</span>
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="preprocessor">#include "<a class="code" href="main_8h.html">main.h</a>"</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include "<a class="code" href="treescreen_8h.html">treescreen.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="recordtabledata_8h.html">recordtabledata.h</a>"</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="keyword">extern</span> <a class="code" href="classappconfig.html">appconfig</a> <a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>;
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 
<a name="l00011"></a><a class="code" href="classtreescreen.html#7c86707d7c256b918f528e2a89bc2a9b">00011</a> <a class="code" href="classtreescreen.html#7c86707d7c256b918f528e2a89bc2a9b">treescreen::treescreen</a>(QWidget *parent) : QWidget(parent)
<a name="l00012"></a>00012 {
<a name="l00013"></a>00013  <a class="code" href="classtreescreen.html#a6e4728a4524289c2e933abc51d9cb20">setup_actions</a>();
<a name="l00014"></a>00014  <a class="code" href="classtreescreen.html#428e0d2e2f10be1761f2d30343259910">setup_ui</a>();
<a name="l00015"></a>00015 
<a name="l00016"></a>00016  <a class="code" href="classtreescreen.html#d325ba7cf9bd91d3e511aa2a5374293c">init_knowtree</a>(); <span class="comment">// Заполнить дерево веток надо перед определением сигналов</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018  <a class="code" href="classtreescreen.html#b08b4831cde1a5b3065ea9d400eea67d">setup_signals</a>();
<a name="l00019"></a>00019  <a class="code" href="classtreescreen.html#8e899dee280df6b59f982726e4bed7d9">assembly</a>();
<a name="l00020"></a>00020  
<a name="l00021"></a>00021  <span class="comment">// Нужно установить правила показа контекстного самодельного меню</span>
<a name="l00022"></a>00022  <span class="comment">// чтобы оно могло вызываться</span>
<a name="l00023"></a>00023  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setContextMenuPolicy(Qt::CustomContextMenu);
<a name="l00024"></a>00024 }
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 
<a name="l00027"></a><a class="code" href="classtreescreen.html#4e63676f90a8bb091bf5253f61467be3">00027</a> <a class="code" href="classtreescreen.html#4e63676f90a8bb091bf5253f61467be3">treescreen::~treescreen</a>()
<a name="l00028"></a>00028 {
<a name="l00029"></a>00029  
<a name="l00030"></a>00030 }
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="classtreescreen.html#a6e4728a4524289c2e933abc51d9cb20">00033</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#a6e4728a4524289c2e933abc51d9cb20">treescreen::setup_actions</a>(<span class="keywordtype">void</span>)
<a name="l00034"></a>00034 {
<a name="l00035"></a>00035  <span class="comment">// Разворачивание всех подветок</span>
<a name="l00036"></a>00036  <span class="comment">// a-&gt;setShortcut(tr("Ctrl+X"));</span>
<a name="l00037"></a>00037  <a class="code" href="classtreescreen.html#159b44d763e2e9570a67a638938e8ded">action_expand_all_subbranch</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Expand all subbranches"</span>), <span class="keyword">this</span>);
<a name="l00038"></a>00038  <a class="code" href="classtreescreen.html#159b44d763e2e9570a67a638938e8ded">action_expand_all_subbranch</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Expand all subbranches"</span>));
<a name="l00039"></a>00039  <a class="code" href="classtreescreen.html#159b44d763e2e9570a67a638938e8ded">action_expand_all_subbranch</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/expand_all_subbranch.svg"</span>));
<a name="l00040"></a>00040  connect(<a class="code" href="classtreescreen.html#159b44d763e2e9570a67a638938e8ded">action_expand_all_subbranch</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#4fe3c8329879acf9f25b1f7c4751ff20">expand_all_subbranch</a>()));
<a name="l00041"></a>00041  
<a name="l00042"></a>00042  <span class="comment">// Сворачивание всех подветок</span>
<a name="l00043"></a>00043  <a class="code" href="classtreescreen.html#823165521f9f5b521324d9cf4fced89b">action_collapse_all_subbranch</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Collapse all subbranches"</span>), <span class="keyword">this</span>);
<a name="l00044"></a>00044  <a class="code" href="classtreescreen.html#823165521f9f5b521324d9cf4fced89b">action_collapse_all_subbranch</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Collapse all subbranches"</span>));
<a name="l00045"></a>00045  <a class="code" href="classtreescreen.html#823165521f9f5b521324d9cf4fced89b">action_collapse_all_subbranch</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/collapse_all_subbranch.svg"</span>));
<a name="l00046"></a>00046  connect(<a class="code" href="classtreescreen.html#823165521f9f5b521324d9cf4fced89b">action_collapse_all_subbranch</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#c8bae82f6fd32b8af4f5a1c574e968e9">collapse_all_subbranch</a>()));
<a name="l00047"></a>00047 
<a name="l00048"></a>00048  <span class="comment">// Перемещение ветки вверх</span>
<a name="l00049"></a>00049  <a class="code" href="classtreescreen.html#449dbf929f24f5d7053a44f466ad949c">action_move_up_branch</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Move up branch"</span>), <span class="keyword">this</span>);
<a name="l00050"></a>00050  <a class="code" href="classtreescreen.html#449dbf929f24f5d7053a44f466ad949c">action_move_up_branch</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Move up branch"</span>));
<a name="l00051"></a>00051  <a class="code" href="classtreescreen.html#449dbf929f24f5d7053a44f466ad949c">action_move_up_branch</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/move_up.svg"</span>));
<a name="l00052"></a>00052  connect(<a class="code" href="classtreescreen.html#449dbf929f24f5d7053a44f466ad949c">action_move_up_branch</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#c26f6cf14a9f7affadf7f3bcf878276c">move_up_branch</a>()));
<a name="l00053"></a>00053 
<a name="l00054"></a>00054  <span class="comment">// Перемещение ветки вниз</span>
<a name="l00055"></a>00055  <a class="code" href="classtreescreen.html#726867917db47c0873f1e3e05c7101be">action_move_dn_branch</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Move down branch"</span>), <span class="keyword">this</span>);
<a name="l00056"></a>00056  <a class="code" href="classtreescreen.html#726867917db47c0873f1e3e05c7101be">action_move_dn_branch</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Move down branch"</span>));
<a name="l00057"></a>00057  <a class="code" href="classtreescreen.html#726867917db47c0873f1e3e05c7101be">action_move_dn_branch</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/move_dn.svg"</span>));
<a name="l00058"></a>00058  connect(<a class="code" href="classtreescreen.html#726867917db47c0873f1e3e05c7101be">action_move_dn_branch</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#d8c480504601e4479ea60b7829965c83">move_dn_branch</a>()));
<a name="l00059"></a>00059 
<a name="l00060"></a>00060  <span class="comment">// Вставка новой подветки</span>
<a name="l00061"></a>00061  <a class="code" href="classtreescreen.html#90bf91aa0d3b10da86514f53d8b826b1">action_ins_subbranch</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Insert new subbranch"</span>), <span class="keyword">this</span>);
<a name="l00062"></a>00062  <a class="code" href="classtreescreen.html#90bf91aa0d3b10da86514f53d8b826b1">action_ins_subbranch</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Insert new subbranch into selected branch"</span>));
<a name="l00063"></a>00063  <a class="code" href="classtreescreen.html#90bf91aa0d3b10da86514f53d8b826b1">action_ins_subbranch</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/add_subbranch.svg"</span>));
<a name="l00064"></a>00064  connect(<a class="code" href="classtreescreen.html#90bf91aa0d3b10da86514f53d8b826b1">action_ins_subbranch</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#cd15b2918f7168a1d3417049897cb4a0">ins_subbranch</a>()));
<a name="l00065"></a>00065 
<a name="l00066"></a>00066  <span class="comment">// Вставка новой ветки</span>
<a name="l00067"></a>00067  <a class="code" href="classtreescreen.html#ab5ee2502a63997e608205efaeb79225">action_ins_branch</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Insert new branch"</span>), <span class="keyword">this</span>);
<a name="l00068"></a>00068  <a class="code" href="classtreescreen.html#ab5ee2502a63997e608205efaeb79225">action_ins_branch</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Insert new branch after sibling selected branch"</span>));
<a name="l00069"></a>00069  <a class="code" href="classtreescreen.html#ab5ee2502a63997e608205efaeb79225">action_ins_branch</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/add_branch.svg"</span>));
<a name="l00070"></a>00070  connect(<a class="code" href="classtreescreen.html#ab5ee2502a63997e608205efaeb79225">action_ins_branch</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#e848a61138838b217020dbf3cc5abb59">ins_branch</a>()));
<a name="l00071"></a>00071 
<a name="l00072"></a>00072  <span class="comment">// Редактирование ветки</span>
<a name="l00073"></a>00073  <a class="code" href="classtreescreen.html#5b276116c7d715ff363b3ff93279e26d">action_edit_branch</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Edit branch name"</span>), <span class="keyword">this</span>);
<a name="l00074"></a>00074  <a class="code" href="classtreescreen.html#5b276116c7d715ff363b3ff93279e26d">action_edit_branch</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Edit name of selected branch"</span>));
<a name="l00075"></a>00075  <a class="code" href="classtreescreen.html#5b276116c7d715ff363b3ff93279e26d">action_edit_branch</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/note_edit.svg"</span>));
<a name="l00076"></a>00076  connect(<a class="code" href="classtreescreen.html#5b276116c7d715ff363b3ff93279e26d">action_edit_branch</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#85bc8eddf559b57cc4def353d10e72c2">edit_branch</a>()));
<a name="l00077"></a>00077 
<a name="l00078"></a>00078  <span class="comment">// Удаление ветки</span>
<a name="l00079"></a>00079  <a class="code" href="classtreescreen.html#723ef6926d4df31046a826ba3463546c">action_del_branch</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Delete branch"</span>), <span class="keyword">this</span>);
<a name="l00080"></a>00080  <a class="code" href="classtreescreen.html#723ef6926d4df31046a826ba3463546c">action_del_branch</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Delete selected branch and all subbranches"</span>));
<a name="l00081"></a>00081  <a class="code" href="classtreescreen.html#723ef6926d4df31046a826ba3463546c">action_del_branch</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/note_delete.svg"</span>));
<a name="l00082"></a>00082  connect(<a class="code" href="classtreescreen.html#723ef6926d4df31046a826ba3463546c">action_del_branch</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#885306bda7c974cee638bbd06bfb8502">del_branch</a>()));
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="classtreescreen.html#428e0d2e2f10be1761f2d30343259910">00087</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#428e0d2e2f10be1761f2d30343259910">treescreen::setup_ui</a>(<span class="keywordtype">void</span>)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>=<span class="keyword">new</span> QToolBar(<span class="keyword">this</span>);
<a name="l00090"></a>00090  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addAction(<a class="code" href="classtreescreen.html#90bf91aa0d3b10da86514f53d8b826b1">action_ins_subbranch</a>);
<a name="l00091"></a>00091  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addAction(<a class="code" href="classtreescreen.html#ab5ee2502a63997e608205efaeb79225">action_ins_branch</a>);
<a name="l00092"></a>00092  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addAction(<a class="code" href="classtreescreen.html#5b276116c7d715ff363b3ff93279e26d">action_edit_branch</a>);
<a name="l00093"></a>00093  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addAction(<a class="code" href="classtreescreen.html#723ef6926d4df31046a826ba3463546c">action_del_branch</a>);
<a name="l00094"></a>00094  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addSeparator();
<a name="l00095"></a>00095  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addAction(<a class="code" href="classtreescreen.html#159b44d763e2e9570a67a638938e8ded">action_expand_all_subbranch</a>);
<a name="l00096"></a>00096  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addAction(<a class="code" href="classtreescreen.html#823165521f9f5b521324d9cf4fced89b">action_collapse_all_subbranch</a>);
<a name="l00097"></a>00097  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addSeparator();
<a name="l00098"></a>00098  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addAction(<a class="code" href="classtreescreen.html#449dbf929f24f5d7053a44f466ad949c">action_move_up_branch</a>);
<a name="l00099"></a>00099  <a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>-&gt;addAction(<a class="code" href="classtreescreen.html#726867917db47c0873f1e3e05c7101be">action_move_dn_branch</a>);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>=<span class="keyword">new</span> QTreeView(<span class="keyword">this</span>);
<a name="l00102"></a>00102  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setObjectName(<span class="stringliteral">"knowtree"</span>);
<a name="l00103"></a>00103  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setMinimumSize(150,400);
<a name="l00104"></a>00104  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setWordWrap(<span class="keyword">true</span>);
<a name="l00105"></a>00105  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setSelectionMode(QAbstractItemView::ExtendedSelection);
<a name="l00106"></a>00106  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOn);
<a name="l00107"></a>00107  
<a name="l00108"></a>00108  <span class="comment">// setHeader ( QHeaderView * header )</span>
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="comment">// Открытие контекстного меню в дереве разделов</span>
<a name="l00113"></a><a class="code" href="classtreescreen.html#be096223f04da6a625e2ed143b983997">00113</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#be096223f04da6a625e2ed143b983997">treescreen::on_customContextMenuRequested</a>(<span class="keyword">const</span> QPoint &amp;pos)
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115   qDebug() &lt;&lt; <span class="stringliteral">"In treescreen on_customContextMenuRequested"</span>;
<a name="l00116"></a>00116   
<a name="l00117"></a>00117   <span class="comment">// Конструирование меню</span>
<a name="l00118"></a>00118   QMenu menu(<span class="keyword">this</span>);
<a name="l00119"></a>00119   menu.addAction(<a class="code" href="classtreescreen.html#90bf91aa0d3b10da86514f53d8b826b1">action_ins_subbranch</a>);
<a name="l00120"></a>00120   menu.addAction(<a class="code" href="classtreescreen.html#ab5ee2502a63997e608205efaeb79225">action_ins_branch</a>);
<a name="l00121"></a>00121   menu.addAction(<a class="code" href="classtreescreen.html#5b276116c7d715ff363b3ff93279e26d">action_edit_branch</a>);
<a name="l00122"></a>00122   menu.addAction(<a class="code" href="classtreescreen.html#723ef6926d4df31046a826ba3463546c">action_del_branch</a>);
<a name="l00123"></a>00123   menu.addSeparator();
<a name="l00124"></a>00124   menu.addAction(<a class="code" href="classtreescreen.html#159b44d763e2e9570a67a638938e8ded">action_expand_all_subbranch</a>);
<a name="l00125"></a>00125   menu.addAction(<a class="code" href="classtreescreen.html#823165521f9f5b521324d9cf4fced89b">action_collapse_all_subbranch</a>);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127   <span class="comment">// Включение отображения меню на экране</span>
<a name="l00128"></a>00128   <span class="comment">// menu.exec(event-&gt;globalPos());</span>
<a name="l00129"></a>00129   menu.exec(<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;viewport()-&gt;mapToGlobal(pos));
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="classtreescreen.html#b08b4831cde1a5b3065ea9d400eea67d">00133</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#b08b4831cde1a5b3065ea9d400eea67d">treescreen::setup_signals</a>(<span class="keywordtype">void</span>)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135  <span class="comment">// Сигнал чтобы показать контекстное меню по правому клику на ветке</span>
<a name="l00136"></a>00136  connect(<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>,SIGNAL(customContextMenuRequested(<span class="keyword">const</span> QPoint &amp;)),
<a name="l00137"></a>00137          <span class="keyword">this</span>,SLOT(<a class="code" href="classtreescreen.html#be096223f04da6a625e2ed143b983997">on_customContextMenuRequested</a>(<span class="keyword">const</span> QPoint &amp;)));
<a name="l00138"></a>00138 
<a name="l00139"></a>00139  <span class="comment">// Сигнал что ветка выбрана мышкой или стрелками на клавиатуре</span>
<a name="l00140"></a>00140  connect(<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel(), SIGNAL(currentRowChanged (<span class="keyword">const</span> QModelIndex&amp;, <span class="keyword">const</span> QModelIndex&amp;)),
<a name="l00141"></a>00141          <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#5ebfb6607ec8ad14d44ec1e6c3dd2389">on_knowtree_clicked</a>(<span class="keyword">const</span> QModelIndex&amp;)));
<a name="l00142"></a>00142  
<a name="l00143"></a>00143  <span class="comment">// Сигнал чтобы открыть на редактирование параметры записи при двойном клике</span>
<a name="l00144"></a>00144  connect(<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>, SIGNAL(doubleClicked(<span class="keyword">const</span> QModelIndex &amp;)),
<a name="l00145"></a>00145          <span class="keyword">this</span>, SLOT(<a class="code" href="classtreescreen.html#85bc8eddf559b57cc4def353d10e72c2">edit_branch</a>(<span class="keywordtype">void</span>)));
<a name="l00146"></a>00146 
<a name="l00147"></a>00147  <span class="comment">// Сигнал что ветка выбрана мышкой</span>
<a name="l00148"></a>00148  <span class="comment">// connect(knowtree,SIGNAL(pressed(const QModelIndex &amp;)),</span>
<a name="l00149"></a>00149  <span class="comment">//         this,SLOT(on_knowtree_clicked(const QModelIndex &amp;)));</span>
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 
<a name="l00153"></a><a class="code" href="classtreescreen.html#8e899dee280df6b59f982726e4bed7d9">00153</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#8e899dee280df6b59f982726e4bed7d9">treescreen::assembly</a>(<span class="keywordtype">void</span>)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155  <a class="code" href="classtreescreen.html#87613c12a99430668ea2b3e2d3575b06">treescreen_layout</a>=<span class="keyword">new</span> QVBoxLayout();
<a name="l00156"></a>00156  <a class="code" href="classtreescreen.html#87613c12a99430668ea2b3e2d3575b06">treescreen_layout</a>-&gt;setObjectName(<span class="stringliteral">"treescreen_QVBoxLayout"</span>);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158  <a class="code" href="classtreescreen.html#87613c12a99430668ea2b3e2d3575b06">treescreen_layout</a>-&gt;addWidget(<a class="code" href="classtreescreen.html#4b1c78bd36c3ce2a67c4aa082320b2f9">tools_line</a>);
<a name="l00159"></a>00159  <a class="code" href="classtreescreen.html#87613c12a99430668ea2b3e2d3575b06">treescreen_layout</a>-&gt;addWidget(<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>);
<a name="l00160"></a>00160 
<a name="l00161"></a>00161  setLayout(<a class="code" href="classtreescreen.html#87613c12a99430668ea2b3e2d3575b06">treescreen_layout</a>);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163  <span class="comment">// Границы убираются, так как данный объект будет использоваться как виджет</span>
<a name="l00164"></a>00164  QLayout *lt;
<a name="l00165"></a>00165  lt=layout();
<a name="l00166"></a>00166  lt-&gt;setContentsMargins(0,2,0,0);
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="classtreescreen.html#4fe3c8329879acf9f25b1f7c4751ff20">00170</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#4fe3c8329879acf9f25b1f7c4751ff20">treescreen::expand_all_subbranch</a>(<span class="keywordtype">void</span>)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172  <span class="comment">// Получение индексов выделенных строк</span>
<a name="l00173"></a>00173  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00174"></a>00174 
<a name="l00175"></a>00175  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; selectitems.size(); ++i) 
<a name="l00176"></a>00176   <a class="code" href="classtreescreen.html#bc30a814c261100adbc6a7d21acae930">expand_or_collapse_recurse</a>(selectitems.at(i), <span class="keyword">true</span>);
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 
<a name="l00180"></a><a class="code" href="classtreescreen.html#c8bae82f6fd32b8af4f5a1c574e968e9">00180</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#c8bae82f6fd32b8af4f5a1c574e968e9">treescreen::collapse_all_subbranch</a>(<span class="keywordtype">void</span>)
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182  <span class="comment">// Получение индексов выделенных строк</span>
<a name="l00183"></a>00183  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00184"></a>00184 
<a name="l00185"></a>00185  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; selectitems.size(); ++i) 
<a name="l00186"></a>00186   <a class="code" href="classtreescreen.html#bc30a814c261100adbc6a7d21acae930">expand_or_collapse_recurse</a>(selectitems.at(i), <span class="keyword">false</span>);
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 
<a name="l00190"></a><a class="code" href="classtreescreen.html#bc30a814c261100adbc6a7d21acae930">00190</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#bc30a814c261100adbc6a7d21acae930">treescreen::expand_or_collapse_recurse</a>(QModelIndex index,<span class="keywordtype">bool</span> mode)
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setExpanded(index, mode);
<a name="l00193"></a>00193 
<a name="l00194"></a>00194  <span class="keywordtype">int</span> i=0;
<a name="l00195"></a>00195  <span class="keywordflow">while</span>( (index.child(i,0)).isValid() )  
<a name="l00196"></a>00196   {
<a name="l00197"></a>00197    <a class="code" href="classtreescreen.html#bc30a814c261100adbc6a7d21acae930">expand_or_collapse_recurse</a>(index.child(i,0), mode);
<a name="l00198"></a>00198    i++;
<a name="l00199"></a>00199   } 
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="classtreescreen.html#c26f6cf14a9f7affadf7f3bcf878276c">00204</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#c26f6cf14a9f7affadf7f3bcf878276c">treescreen::move_up_branch</a>(<span class="keywordtype">void</span>)
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206  <a class="code" href="classtreescreen.html#773a34b2a15964d0101b142b54da3986">move_updn_branch</a>(1);
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 
<a name="l00210"></a><a class="code" href="classtreescreen.html#d8c480504601e4479ea60b7829965c83">00210</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#d8c480504601e4479ea60b7829965c83">treescreen::move_dn_branch</a>(<span class="keywordtype">void</span>)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212  <a class="code" href="classtreescreen.html#773a34b2a15964d0101b142b54da3986">move_updn_branch</a>(-1);
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="classtreescreen.html#773a34b2a15964d0101b142b54da3986">00216</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#773a34b2a15964d0101b142b54da3986">treescreen::move_updn_branch</a>(<span class="keywordtype">int</span> direction)
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218  <span class="comment">// Если ветку нельзя перемещать</span>
<a name="l00219"></a>00219  <span class="keywordflow">if</span>(!<a class="code" href="classtreescreen.html#66dff8576eca276e70d0d778a283eff7">move_check_enable</a>()) <span class="keywordflow">return</span>;
<a name="l00220"></a>00220  
<a name="l00221"></a>00221  <span class="comment">// Получение индекса выделенной строки</span>
<a name="l00222"></a>00222  QModelIndex index=<a class="code" href="classtreescreen.html#8b56108409028dc2c0996ac573fa7ff9">get_current_item_index</a>();
<a name="l00223"></a>00223  
<a name="l00224"></a>00224  <span class="comment">// Ветка перемещается</span>
<a name="l00225"></a>00225  QModelIndex index_after_move;
<a name="l00226"></a>00226  <span class="keywordflow">if</span>(direction==1) index_after_move=<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classknowtreemodel.html#dde544e3e416a51e6e132fa2f07426f8">move_up_branch</a>(index);
<a name="l00227"></a>00227  <span class="keywordflow">else</span>             index_after_move=<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classknowtreemodel.html#d9fc7fb894fad944f7e02556ddfa375e">move_dn_branch</a>(index);
<a name="l00228"></a>00228   
<a name="l00229"></a>00229  <span class="comment">// Установка курсора на позицию, куда была перенесена ветка</span>
<a name="l00230"></a>00230  <span class="keywordflow">if</span>(index_after_move.isValid())
<a name="l00231"></a>00231   {
<a name="l00232"></a>00232    <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;setCurrentIndex(index_after_move,QItemSelectionModel::ClearAndSelect | QItemSelectionModel::Current);
<a name="l00233"></a>00233    <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;select(index_after_move,QItemSelectionModel::ClearAndSelect | QItemSelectionModel::Current);
<a name="l00234"></a>00234   } 
<a name="l00235"></a>00235  
<a name="l00236"></a>00236  <span class="comment">// Сохранение дерева веток</span>
<a name="l00237"></a>00237  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;<a class="code" href="classtreescreen.html#5ecf27898d34e891ee560e25d28e8ffa">save_knowtree</a>();
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 
<a name="l00241"></a><a class="code" href="classtreescreen.html#66dff8576eca276e70d0d778a283eff7">00241</a> <span class="keywordtype">bool</span> <a class="code" href="classtreescreen.html#66dff8576eca276e70d0d778a283eff7">treescreen::move_check_enable</a>(<span class="keywordtype">void</span>)
<a name="l00242"></a>00242 {
<a name="l00243"></a>00243  <span class="comment">// Получение списка индексов QModelIndex выделенных элементов</span>
<a name="l00244"></a>00244  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00245"></a>00245  
<a name="l00246"></a>00246  <span class="comment">// Если выбрано более одной ветки</span>
<a name="l00247"></a>00247  <span class="keywordflow">if</span>(selectitems.size()&gt;1)
<a name="l00248"></a>00248   {
<a name="l00249"></a>00249    QMessageBox messageBox(<span class="keyword">this</span>);
<a name="l00250"></a>00250    messageBox.setWindowTitle(tr(<span class="stringliteral">"Unavailable action"</span>));
<a name="l00251"></a>00251    messageBox.setText(tr(<span class="stringliteral">"You select "</span>)+QString::number(selectitems.size())+tr(<span class="stringliteral">" branches.\nPlease select one branch for moving."</span>));
<a name="l00252"></a>00252    QAbstractButton *okButton =messageBox.addButton(tr(<span class="stringliteral">"Ok"</span>),QMessageBox::AcceptRole);
<a name="l00253"></a>00253    messageBox.exec();
<a name="l00254"></a>00254    <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256  <span class="keywordflow">else</span>
<a name="l00257"></a>00257   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 
<a name="l00261"></a><a class="code" href="classtreescreen.html#cd15b2918f7168a1d3417049897cb4a0">00261</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#cd15b2918f7168a1d3417049897cb4a0">treescreen::ins_subbranch</a>(<span class="keywordtype">void</span>)
<a name="l00262"></a>00262 {
<a name="l00263"></a>00263  qDebug() &lt;&lt; <span class="stringliteral">"In ins_subbranch()"</span>;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265  <span class="comment">// Получение списка индексов QModelIndex выделенных элементов</span>
<a name="l00266"></a>00266  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00267"></a>00267  
<a name="l00268"></a>00268  <span class="comment">// Если выбрано более одной ветки</span>
<a name="l00269"></a>00269  <span class="keywordflow">if</span>(selectitems.size()&gt;1)
<a name="l00270"></a>00270   {
<a name="l00271"></a>00271    QMessageBox messageBox(<span class="keyword">this</span>);
<a name="l00272"></a>00272    messageBox.setWindowTitle(tr(<span class="stringliteral">"Unavailable action"</span>));
<a name="l00273"></a>00273    messageBox.setText(tr(<span class="stringliteral">"You select "</span>)+QString::number(selectitems.size())+tr(<span class="stringliteral">" branches.\nPlease select one branch for insert subbranch."</span>));
<a name="l00274"></a>00274    QAbstractButton *okButton =messageBox.addButton(tr(<span class="stringliteral">"Ok"</span>),QMessageBox::AcceptRole);
<a name="l00275"></a>00275    messageBox.exec();
<a name="l00276"></a>00276    <span class="keywordflow">return</span>; 
<a name="l00277"></a>00277   }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279  
<a name="l00280"></a>00280  <span class="comment">// Получение индекса выделенной строки</span>
<a name="l00281"></a>00281  QModelIndex index=<a class="code" href="classtreescreen.html#8b56108409028dc2c0996ac573fa7ff9">get_current_item_index</a>();
<a name="l00282"></a>00282  
<a name="l00283"></a>00283  <span class="comment">// Получение ссылки на узел, который соответствует выделенной строке</span>
<a name="l00284"></a>00284  <a class="code" href="classTreeItem.html">TreeItem</a> *item=<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classTreeModel.html#4944fbea068c3d4bc7b25f4a7087b5f0">getItem</a>(index);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286  <span class="comment">// Если ветка содержит непустую таблицу конечных записей</span>
<a name="l00287"></a>00287  <span class="comment">// Изменено. Теперь можно добавлять подветки к любым веткам</span>
<a name="l00288"></a>00288  <span class="comment">/*</span>
<a name="l00289"></a>00289 <span class="comment"> if(item-&gt;recordtable_getrowcount()&gt;0)</span>
<a name="l00290"></a>00290 <span class="comment">  {</span>
<a name="l00291"></a>00291 <span class="comment">   QMessageBox::information(this, </span>
<a name="l00292"></a>00292 <span class="comment">                            tr("myTetra"),</span>
<a name="l00293"></a>00293 <span class="comment">                            tr("This branch have records.\nAppend new subbranch enable only to empty branch."));</span>
<a name="l00294"></a>00294 <span class="comment">   return;</span>
<a name="l00295"></a>00295 <span class="comment">  }</span>
<a name="l00296"></a>00296 <span class="comment"> */</span>
<a name="l00297"></a>00297  
<a name="l00298"></a>00298  <span class="comment">// Создается окно ввода данных</span>
<a name="l00299"></a>00299  <span class="keywordtype">bool</span> ok;
<a name="l00300"></a>00300  QString name = QInputDialog::getText(<span class="keyword">this</span>, 
<a name="l00301"></a>00301                                       tr(<span class="stringliteral">"Insert new subbranch"</span>),
<a name="l00302"></a>00302                                       tr(<span class="stringliteral">"Subbranch name:"</span>), 
<a name="l00303"></a>00303                                       QLineEdit::Normal,
<a name="l00304"></a>00304                                       <span class="stringliteral">""</span>, 
<a name="l00305"></a>00305                                       &amp;ok);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307  <span class="comment">// Если была нажата отмена</span>
<a name="l00308"></a>00308  <span class="keywordflow">if</span> (!( ok &amp;&amp; !name.isEmpty() )) <span class="keywordflow">return</span>; 
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 
<a name="l00311"></a>00311  <span class="comment">// Введенные данные добавляются</span>
<a name="l00312"></a>00312  
<a name="l00313"></a>00313  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setDisabled(<span class="keyword">true</span>);
<a name="l00314"></a>00314  
<a name="l00315"></a>00315  <span class="comment">// Получение и установка номера последнего идентификатора XML записи</span>
<a name="l00316"></a>00316  <span class="keywordtype">int</span> idnum=<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#098e273bf84b2ce0ffcf69ce98d99acb">get_lastidnum</a>();
<a name="l00317"></a>00317  <a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#fe3089f67aa81ee6d5e8bd50dfe62e6b">inc_lastidnum</a>();
<a name="l00318"></a>00318  QString id;
<a name="l00319"></a>00319  <span class="keywordtype">id</span>.setNum(idnum);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321  <span class="comment">// Вставка новых данных в модель дерева записей</span>
<a name="l00322"></a>00322  <a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classknowtreemodel.html#9a5cf7df4f0e7a1362e1eaa725b7826b">add_new_child_branch</a>(index,<span class="keywordtype">id</span>,name);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324  <span class="comment">// Установка курсора на только что созданную позицию</span>
<a name="l00325"></a>00325  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;setCurrentIndex(<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classknowtreemodel.html#7802e8122c237aabd9050ed36295999f">indexChildren</a>(index,item-&gt;<a class="code" href="classTreeItem.html#14551ec37f50067974fc93aa78b4b6e1">childCount</a>()-1),
<a name="l00326"></a>00326                                              QItemSelectionModel::ClearAndSelect);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328  <span class="comment">// А можно было установить курсор на нужную позицию и так</span>
<a name="l00329"></a>00329  <span class="comment">// knowtree-&gt;selectionModel()-&gt;setCurrentIndex(kntrmodel-&gt;index(item-&gt;childCount()-1,0,index),</span>
<a name="l00330"></a>00330  <span class="comment">//                                             QItemSelectionModel::ClearAndSelect);</span>
<a name="l00331"></a>00331  
<a name="l00332"></a>00332  <span class="comment">// Сохранение дерева веток</span>
<a name="l00333"></a>00333  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;<a class="code" href="classtreescreen.html#5ecf27898d34e891ee560e25d28e8ffa">save_knowtree</a>();
<a name="l00334"></a>00334 
<a name="l00335"></a>00335  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 
<a name="l00339"></a><a class="code" href="classtreescreen.html#e848a61138838b217020dbf3cc5abb59">00339</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#e848a61138838b217020dbf3cc5abb59">treescreen::ins_branch</a>(<span class="keywordtype">void</span>)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341  qDebug() &lt;&lt; <span class="stringliteral">"In ins_branch()"</span>;
<a name="l00342"></a>00342  
<a name="l00343"></a>00343   <span class="comment">// Получение списка индексов QModelIndex выделенных элементов</span>
<a name="l00344"></a>00344  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00345"></a>00345  
<a name="l00346"></a>00346  <span class="comment">// Если выбрано более одной ветки</span>
<a name="l00347"></a>00347  <span class="keywordflow">if</span>(selectitems.size()&gt;1)
<a name="l00348"></a>00348   {
<a name="l00349"></a>00349    QMessageBox messageBox(<span class="keyword">this</span>);
<a name="l00350"></a>00350    messageBox.setWindowTitle(tr(<span class="stringliteral">"Unavailable action"</span>));
<a name="l00351"></a>00351    messageBox.setText(tr(<span class="stringliteral">"You select "</span>)+QString::number(selectitems.size())+tr(<span class="stringliteral">" branches.\nPlease select one branch for insert sibling branch."</span>));
<a name="l00352"></a>00352    QAbstractButton *okButton =messageBox.addButton(tr(<span class="stringliteral">"Ok"</span>),QMessageBox::AcceptRole);
<a name="l00353"></a>00353    messageBox.exec();
<a name="l00354"></a>00354    <span class="keywordflow">return</span>; 
<a name="l00355"></a>00355   }
<a name="l00356"></a>00356  
<a name="l00357"></a>00357 
<a name="l00358"></a>00358   <span class="comment">// Получение индекса выделенной строки</span>
<a name="l00359"></a>00359  QModelIndex index=<a class="code" href="classtreescreen.html#8b56108409028dc2c0996ac573fa7ff9">get_current_item_index</a>();
<a name="l00360"></a>00360  
<a name="l00361"></a>00361  <span class="comment">// Получение ссылки на узел, который соответствует выделенной строке</span>
<a name="l00362"></a>00362  <a class="code" href="classTreeItem.html">TreeItem</a> *item=<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classTreeModel.html#4944fbea068c3d4bc7b25f4a7087b5f0">getItem</a>(index);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364  <span class="comment">// Создается окно ввода данных</span>
<a name="l00365"></a>00365  <span class="keywordtype">bool</span> ok;
<a name="l00366"></a>00366  QString name = QInputDialog::getText(<span class="keyword">this</span>, 
<a name="l00367"></a>00367                                       tr(<span class="stringliteral">"Insert new branch"</span>),
<a name="l00368"></a>00368                                       tr(<span class="stringliteral">"Branch name:"</span>), 
<a name="l00369"></a>00369                                       QLineEdit::Normal,
<a name="l00370"></a>00370                                       <span class="stringliteral">""</span>, 
<a name="l00371"></a>00371                                       &amp;ok);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373  <span class="comment">// Если была нажата отмена</span>
<a name="l00374"></a>00374  <span class="keywordflow">if</span> (!( ok &amp;&amp; !name.isEmpty() )) <span class="keywordflow">return</span>; 
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00377"></a>00377  <span class="comment">// Введенные данные добавляются</span>
<a name="l00378"></a>00378  
<a name="l00379"></a>00379  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setDisabled(<span class="keyword">true</span>);
<a name="l00380"></a>00380  
<a name="l00381"></a>00381  <span class="comment">// Получение и установка номера последнего идентификатора XML записи</span>
<a name="l00382"></a>00382  <span class="keywordtype">int</span> idnum=<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#098e273bf84b2ce0ffcf69ce98d99acb">get_lastidnum</a>();
<a name="l00383"></a>00383  <a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#fe3089f67aa81ee6d5e8bd50dfe62e6b">inc_lastidnum</a>();
<a name="l00384"></a>00384  QString id;
<a name="l00385"></a>00385  <span class="keywordtype">id</span>.setNum(idnum);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387  <span class="comment">// Вставка новых данных в модель дерева записей</span>
<a name="l00388"></a>00388  <a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classknowtreemodel.html#db22fa31851d2020284c5713ad98e1f1">add_new_sibling_branch</a>(index,<span class="keywordtype">id</span>,name);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390  <span class="comment">// Установка курсора на только что созданную позицию</span>
<a name="l00391"></a>00391 
<a name="l00392"></a>00392  <span class="comment">// Чтобы вычислить позицию, надо синхронно получить parent элемента,</span>
<a name="l00393"></a>00393  <span class="comment">// на уровне которого должен был создасться новый элемент.</span>
<a name="l00394"></a>00394  <span class="comment">// Parent надо получить и в виде объекта QModelIndex, и в виде объекта Item</span>
<a name="l00395"></a>00395  <span class="comment">// Затем у объекта Item выяснить количество элементов, и установить</span>
<a name="l00396"></a>00396  <span class="comment">// засветку через метод index() относительно parent в виде QModelIndex</span>
<a name="l00397"></a>00397  QModelIndex setto=<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classTreeModel.html#0e6e6bbdb55d08be64cab7bafba2ce21">index</a>(item-&gt;<a class="code" href="classTreeItem.html#392ec493dfab91ee474d7ff83e2c0211">parent</a>()-&gt;<a class="code" href="classTreeItem.html#14551ec37f50067974fc93aa78b4b6e1">childCount</a>()-1,0,index.parent());
<a name="l00398"></a>00398  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;setCurrentIndex(setto,QItemSelectionModel::ClearAndSelect);
<a name="l00399"></a>00399  
<a name="l00400"></a>00400  <span class="comment">// Сохранение дерева веток</span>
<a name="l00401"></a>00401  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;<a class="code" href="classtreescreen.html#5ecf27898d34e891ee560e25d28e8ffa">save_knowtree</a>();
<a name="l00402"></a>00402 
<a name="l00403"></a>00403  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00404"></a>00404 }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406 
<a name="l00407"></a><a class="code" href="classtreescreen.html#b41c15b069309faebf37cb1b0ad245f1">00407</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#b41c15b069309faebf37cb1b0ad245f1">treescreen::insert_new_branch</a>(<span class="keywordtype">void</span>)
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409  
<a name="l00410"></a>00410  
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 
<a name="l00414"></a><a class="code" href="classtreescreen.html#85bc8eddf559b57cc4def353d10e72c2">00414</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#85bc8eddf559b57cc4def353d10e72c2">treescreen::edit_branch</a>(<span class="keywordtype">void</span>)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416  qDebug() &lt;&lt; <span class="stringliteral">"In edit_branch()"</span>;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   <span class="comment">// Получение списка индексов QModelIndex выделенных элементов</span>
<a name="l00419"></a>00419  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00420"></a>00420  
<a name="l00421"></a>00421  <span class="comment">// Если выбрано более одной ветки</span>
<a name="l00422"></a>00422  <span class="keywordflow">if</span>(selectitems.size()&gt;1)
<a name="l00423"></a>00423   {
<a name="l00424"></a>00424    QMessageBox messageBox(<span class="keyword">this</span>);
<a name="l00425"></a>00425    messageBox.setWindowTitle(tr(<span class="stringliteral">"Unavailable action"</span>));
<a name="l00426"></a>00426    messageBox.setText(tr(<span class="stringliteral">"You select "</span>)+QString::number(selectitems.size())+tr(<span class="stringliteral">" branches.\nPlease select one branch for edit name."</span>));
<a name="l00427"></a>00427    QAbstractButton *okButton =messageBox.addButton(tr(<span class="stringliteral">"Ok"</span>),QMessageBox::AcceptRole);
<a name="l00428"></a>00428    messageBox.exec();
<a name="l00429"></a>00429    <span class="keywordflow">return</span>; 
<a name="l00430"></a>00430   }
<a name="l00431"></a>00431  
<a name="l00432"></a>00432  <span class="comment">// Получение индекса выделенной строки</span>
<a name="l00433"></a>00433  QModelIndex index=<a class="code" href="classtreescreen.html#8b56108409028dc2c0996ac573fa7ff9">get_current_item_index</a>();
<a name="l00434"></a>00434  
<a name="l00435"></a>00435  <span class="comment">// Получение ссылки на узел, который соответствует выделенной строке</span>
<a name="l00436"></a>00436  <a class="code" href="classTreeItem.html">TreeItem</a> *item=<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classTreeModel.html#4944fbea068c3d4bc7b25f4a7087b5f0">getItem</a>(index);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438  <span class="comment">// Получение имени ветки</span>
<a name="l00439"></a>00439  QString name=(item-&gt;<a class="code" href="classTreeItem.html#30f59edac140c6fa48b5f09315e15a65">data</a>(<span class="stringliteral">"name"</span>)).toString();
<a name="l00440"></a>00440   
<a name="l00441"></a>00441  <span class="comment">// Создается окно ввода данных</span>
<a name="l00442"></a>00442  <span class="keywordtype">bool</span> ok;
<a name="l00443"></a>00443  QString newname = QInputDialog::getText(<span class="keyword">this</span>, 
<a name="l00444"></a>00444                                       tr(<span class="stringliteral">"Edit branch name"</span>),
<a name="l00445"></a>00445                                       tr(<span class="stringliteral">"Branch name:"</span>), 
<a name="l00446"></a>00446                                       QLineEdit::Normal,
<a name="l00447"></a>00447                                       name, 
<a name="l00448"></a>00448                                       &amp;ok);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450  <span class="comment">// Если была нажата отмена</span>
<a name="l00451"></a>00451  <span class="keywordflow">if</span> (!( ok &amp;&amp; !newname.isEmpty() )) <span class="keywordflow">return</span>; 
<a name="l00452"></a>00452 
<a name="l00453"></a>00453  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setDisabled(<span class="keyword">true</span>);
<a name="l00454"></a>00454  
<a name="l00455"></a>00455  item-&gt;<a class="code" href="classTreeItem.html#4e613f935d91a595e2b61e06726bc364">setData</a>(<span class="stringliteral">"name"</span>,newname);
<a name="l00456"></a>00456  
<a name="l00457"></a>00457  <span class="comment">// Сохранение дерева веток</span>
<a name="l00458"></a>00458  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;<a class="code" href="classtreescreen.html#5ecf27898d34e891ee560e25d28e8ffa">save_knowtree</a>();
<a name="l00459"></a>00459  
<a name="l00460"></a>00460  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 
<a name="l00465"></a><a class="code" href="classtreescreen.html#885306bda7c974cee638bbd06bfb8502">00465</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#885306bda7c974cee638bbd06bfb8502">treescreen::del_branch</a>(<span class="keywordtype">void</span>)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467  qDebug() &lt;&lt; <span class="stringliteral">"In del_branch()"</span>;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469  <span class="comment">// Получение списка индексов QModelIndex выделенных элементов</span>
<a name="l00470"></a>00470  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00471"></a>00471  
<a name="l00472"></a>00472  <span class="comment">// Если выбрано более одной ветки</span>
<a name="l00473"></a>00473  <span class="keywordflow">if</span>(selectitems.size()&gt;1)
<a name="l00474"></a>00474   {
<a name="l00475"></a>00475    QMessageBox messageBox(<span class="keyword">this</span>);
<a name="l00476"></a>00476    messageBox.setWindowTitle(tr(<span class="stringliteral">"Unavailable action"</span>));
<a name="l00477"></a>00477    messageBox.setText(tr(<span class="stringliteral">"Please select one branch for delete."</span>));
<a name="l00478"></a>00478    QAbstractButton *okButton =messageBox.addButton(tr(<span class="stringliteral">"Ok"</span>),QMessageBox::AcceptRole);
<a name="l00479"></a>00479    messageBox.exec();
<a name="l00480"></a>00480    <span class="keywordflow">return</span>; 
<a name="l00481"></a>00481   }
<a name="l00482"></a>00482  
<a name="l00483"></a>00483  
<a name="l00484"></a>00484  <span class="comment">// Получение индекса выделенной ветки</span>
<a name="l00485"></a>00485  QModelIndex index=<a class="code" href="classtreescreen.html#8b56108409028dc2c0996ac573fa7ff9">get_current_item_index</a>();
<a name="l00486"></a>00486  
<a name="l00487"></a>00487  <span class="comment">// Получение ссылки на узел, который соответствует выделенной ветке</span>
<a name="l00488"></a>00488  <a class="code" href="classTreeItem.html">TreeItem</a> *item=<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classTreeModel.html#4944fbea068c3d4bc7b25f4a7087b5f0">getItem</a>(index);
<a name="l00489"></a>00489  
<a name="l00490"></a>00490  
<a name="l00491"></a>00491  <span class="comment">// Создается окно с вопросом нужно удалять ветку или нет</span>
<a name="l00492"></a>00492  QMessageBox messageBox(<span class="keyword">this</span>);
<a name="l00493"></a>00493  messageBox.setWindowTitle(tr(<span class="stringliteral">"Delete branch"</span>));
<a name="l00494"></a>00494  messageBox.setText(tr(<span class="stringliteral">"Are you sure to delete branch "</span>) + (item-&gt;<a class="code" href="classTreeItem.html#30f59edac140c6fa48b5f09315e15a65">data</a>(<span class="stringliteral">"name"</span>)).toString() + tr(<span class="stringliteral">" and it subbranches?"</span>));
<a name="l00495"></a>00495  QAbstractButton *cancelButton =messageBox.addButton(tr(<span class="stringliteral">"Cancel"</span>), QMessageBox::RejectRole);
<a name="l00496"></a>00496  QAbstractButton *deleteButton =messageBox.addButton(tr(<span class="stringliteral">"Delete"</span>), QMessageBox::AcceptRole);
<a name="l00497"></a>00497  messageBox.exec();
<a name="l00498"></a>00498  <span class="keywordflow">if</span>(messageBox.clickedButton() != deleteButton)<span class="keywordflow">return</span>;
<a name="l00499"></a>00499   
<a name="l00500"></a>00500  qDebug() &lt;&lt; <span class="stringliteral">"Before delete item"</span>;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setDisabled(<span class="keyword">true</span>);
<a name="l00503"></a>00503  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;blockSignals(<span class="keyword">true</span>);
<a name="l00504"></a>00504  
<a name="l00505"></a>00505  <span class="comment">// Удаление ветки, при этом удалятся все подветки</span>
<a name="l00506"></a>00506  <span class="comment">// Изнутри функции removeRow(), которая является частью Qt,</span>
<a name="l00507"></a>00507  <span class="comment">// будет вызвана перегруженная для QAbstractItemModel функция </span>
<a name="l00508"></a>00508  <span class="comment">// TreeModel::removeRows(int position, int rows, const QModelIndex &amp;parent)</span>
<a name="l00509"></a>00509  <a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;removeRow(index.row(), index.parent());
<a name="l00510"></a>00510 
<a name="l00511"></a>00511  qDebug() &lt;&lt; <span class="stringliteral">"Arter delete item"</span>;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513  <span class="comment">// Сохранение дерева веток</span>
<a name="l00514"></a>00514  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;<a class="code" href="classtreescreen.html#5ecf27898d34e891ee560e25d28e8ffa">save_knowtree</a>();
<a name="l00515"></a>00515 
<a name="l00516"></a>00516  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00517"></a>00517  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;blockSignals(<span class="keyword">false</span>);
<a name="l00518"></a>00518  
<a name="l00519"></a>00519  <span class="keywordflow">return</span>;
<a name="l00520"></a>00520   
<a name="l00521"></a>00521  <span class="comment">/*</span>
<a name="l00522"></a>00522 <span class="comment"> // Получение пути к элементу</span>
<a name="l00523"></a>00523 <span class="comment"> QStringList path=item-&gt;get_path();</span>
<a name="l00524"></a>00524 <span class="comment"></span>
<a name="l00525"></a>00525 <span class="comment"> // Получение путей ко всем подветкам</span>
<a name="l00526"></a>00526 <span class="comment"> QList&lt;QStringList&gt; subbranchespath=item-&gt;get_all_children_path();</span>
<a name="l00527"></a>00527 <span class="comment"> </span>
<a name="l00528"></a>00528 <span class="comment"> // Сортировка массива веток по длине пути</span>
<a name="l00529"></a>00529 <span class="comment"> qSort(subbranchespath.begin(),subbranchespath.end(),compare_QStringList_len);</span>
<a name="l00530"></a>00530 <span class="comment"> </span>
<a name="l00531"></a>00531 <span class="comment"> // Удаление всех конечных записей для нужных подветок</span>
<a name="l00532"></a>00532 <span class="comment"> // Пробегаются самые длинные ветки а потом более короткие</span>
<a name="l00533"></a>00533 <span class="comment"> for (int i=subbranchespath.size()-1;i&gt;=0;i--) </span>
<a name="l00534"></a>00534 <span class="comment">  ( kntrmodel-&gt;getItem(subbranchespath.at(i)) )-&gt;recordtable_clear();</span>
<a name="l00535"></a>00535 <span class="comment"> </span>
<a name="l00536"></a>00536 <span class="comment"> // Удаление конечных записей для самой удаляемой ветки</span>
<a name="l00537"></a>00537 <span class="comment"> ( kntrmodel-&gt;getItem(path) )-&gt;recordtable_clear();</span>
<a name="l00538"></a>00538 <span class="comment"> </span>
<a name="l00539"></a>00539 <span class="comment"> // Удаление всех нужных подветок</span>
<a name="l00540"></a>00540 <span class="comment"> // Пробегаются самые длинные ветки а потом более короткие</span>
<a name="l00541"></a>00541 <span class="comment"> for (int i=subbranchespath.size()-1;i&gt;=0;i--) </span>
<a name="l00542"></a>00542 <span class="comment">  delete kntrmodel-&gt;getItem(subbranchespath.at(i));</span>
<a name="l00543"></a>00543 <span class="comment"> */</span>
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="comment">// Действия при клике на ветку дерева</span>
<a name="l00549"></a><a class="code" href="classtreescreen.html#5ebfb6607ec8ad14d44ec1e6c3dd2389">00549</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#5ebfb6607ec8ad14d44ec1e6c3dd2389">treescreen::on_knowtree_clicked</a>(<span class="keyword">const</span> QModelIndex &amp;index)
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551  <span class="comment">// QModelIndex index = nodetreeview-&gt;selectionModel()-&gt;currentIndex();</span>
<a name="l00552"></a>00552 
<a name="l00553"></a>00553  <span class="comment">// Сохраняется текст в окне редактирования в соответсвующий файл</span>
<a name="l00554"></a>00554  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;save_current_record_text();
<a name="l00555"></a>00555  
<a name="l00556"></a>00556  <span class="comment">// Получаем указатель на текущую выбранную ветку дерева</span>
<a name="l00557"></a>00557  <a class="code" href="classTreeItem.html">TreeItem</a> *item = <a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classTreeModel.html#4944fbea068c3d4bc7b25f4a7087b5f0">getItem</a>(index);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559  <span class="comment">// Получаем указатель на данные таблицы конечных записей</span>
<a name="l00560"></a>00560  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *rtdata=item-&gt;<a class="code" href="classTreeItem.html#8f23227037841048efa95d2e22d0c2d7">recordtable_gettabledata</a>();
<a name="l00561"></a>00561 
<a name="l00562"></a>00562  <span class="comment">// Устанавливаем данные таблицы конечных записей</span>
<a name="l00563"></a>00563  find_object&lt;recordtablescreen&gt;(<span class="stringliteral">"recordtableview"</span>)-&gt;set_tabledata(rtdata);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565  <span class="comment">// Ширина колонки дерева устанавливается так чтоб всегда вмещались данные</span>
<a name="l00566"></a>00566  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;resizeColumnToContents(0);
<a name="l00567"></a>00567 }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 <span class="comment">/*</span>
<a name="l00570"></a>00570 <span class="comment">void treescreen::on_knowtree_repaint(void)</span>
<a name="l00571"></a>00571 <span class="comment">{</span>
<a name="l00572"></a>00572 <span class="comment"> // Попытка расширить нулевую колонку с деревом, если содержимое слишком широкое</span>
<a name="l00573"></a>00573 <span class="comment"> knowtree-&gt;resizeColumnToContents(0);</span>
<a name="l00574"></a>00574 <span class="comment">}</span>
<a name="l00575"></a>00575 <span class="comment">*/</span>
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 <span class="comment">// Создание дерева разделов</span>
<a name="l00579"></a><a class="code" href="classtreescreen.html#d325ba7cf9bd91d3e511aa2a5374293c">00579</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#d325ba7cf9bd91d3e511aa2a5374293c">treescreen::init_knowtree</a>(<span class="keywordtype">void</span>)
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581  <span class="comment">// Загрузка файла и преобразование его в DOM модель</span>
<a name="l00582"></a>00582  <a class="code" href="classxmltree.html">xmltree</a> xmlt;
<a name="l00583"></a>00583  <span class="keywordflow">if</span>(!xmlt.<a class="code" href="classxmltree.html#40ceaaf2da01e919f0735ad703356e49">load</a>(<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#3d61e98d919332ceb6acb2e03d8f848b">get_tetradir</a>()+<span class="stringliteral">"/mytetra.xml"</span>))<span class="keywordflow">return</span>;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585  QStringList headers;
<a name="l00586"></a>00586  headers &lt;&lt; tr(<span class="stringliteral">"Group of info"</span>);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588  <span class="comment">// Преобразование DOM модели в Item модель</span>
<a name="l00589"></a>00589  <a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a> = <span class="keyword">new</span> <a class="code" href="classknowtreemodel.html">knowtreemodel</a>(headers, xmlt.<a class="code" href="classxmltree.html#6b469b6c9de2ec31c4ba1c8444ba5994">dommodel</a>);
<a name="l00590"></a>00590  
<a name="l00591"></a>00591  <span class="comment">// Загрузка Item модели в представление</span>
<a name="l00592"></a>00592  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setModel(<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594  <span class="comment">// Представление не должно позволять редактировать элементы обычным путем</span>
<a name="l00595"></a>00595  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;setEditTriggers(QAbstractItemView::NoEditTriggers);
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="comment">// Функция сохранения дерева веток</span>
<a name="l00600"></a><a class="code" href="classtreescreen.html#5ecf27898d34e891ee560e25d28e8ffa">00600</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#5ecf27898d34e891ee560e25d28e8ffa">treescreen::save_knowtree</a>(<span class="keywordtype">void</span>)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602  <span class="comment">// Коструирование DOM документа для записи в файл</span>
<a name="l00603"></a>00603  QDomDocument doc(<span class="stringliteral">"mytetradoc"</span>);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605  <span class="comment">// Установка заголовка</span>
<a name="l00606"></a>00606  doc.appendChild(doc.createProcessingInstruction(<span class="stringliteral">"xml"</span>, <span class="stringliteral">"version=\"1.0\" encoding=\"UTF-8\""</span>));
<a name="l00607"></a>00607 
<a name="l00608"></a>00608  <span class="comment">// Создание корневого элемента</span>
<a name="l00609"></a>00609  QDomElement rootelement=doc.createElement(<span class="stringliteral">"root"</span>);
<a name="l00610"></a>00610 
<a name="l00611"></a>00611  <span class="comment">// Добавление формата версии к корневому элементу</span>
<a name="l00612"></a>00612  QDomElement formvers=doc.createElement(<span class="stringliteral">"format"</span>);
<a name="l00613"></a>00613  formvers.setAttribute(<span class="stringliteral">"version"</span>,<a class="code" href="main_8h.html#13494493ae4a0f9ce61e04759b1666b4">CURRENT_FORMAT_VERSION</a>);
<a name="l00614"></a>00614  formvers.setAttribute(<span class="stringliteral">"subversion"</span>,<a class="code" href="main_8h.html#c0afd906320d22ab872498bfd98b2bb9">CURRENT_FORMAT_SUBVERSION</a>);
<a name="l00615"></a>00615  rootelement.appendChild(formvers);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617  <span class="comment">// Получение полного DOM дерева хранимых данных</span>
<a name="l00618"></a>00618  QDomElement elmdomtree=<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classknowtreemodel.html#a1a1e8307a9a1d6de4432ae8bf28a42d">export_fullmodeldata_to_dom</a>(<a class="code" href="classtreescreen.html#9af96a0df5b4e075dd4fc01e0bd8e31d">kntrmodel</a>-&gt;<a class="code" href="classTreeModel.html#8921084214c2ff8a56b15e201f02ed89">rootItem</a>);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620  <span class="comment">// Добавление полного дерева DOM хранимых данных к корневому элементу</span>
<a name="l00621"></a>00621  rootelement.appendChild(elmdomtree);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623  <span class="comment">// Добавление корневого элемента в DOM документ</span>
<a name="l00624"></a>00624  doc.appendChild(rootelement);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626  <span class="comment">// Рспечатка на экран, что будет выводиться в XML файл</span>
<a name="l00627"></a>00627  <span class="comment">// qDebug() &lt;&lt; "Doc document for write " &lt;&lt; doc.toString();</span>
<a name="l00628"></a>00628 
<a name="l00629"></a>00629  <span class="comment">// Перенос текущего файла дерева в резервную директорию</span>
<a name="l00630"></a>00630  QString filenamefrom=<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#3d61e98d919332ceb6acb2e03d8f848b">get_tetradir</a>()+<span class="stringliteral">"/mytetra.xml"</span>;
<a name="l00631"></a>00631  QString filenameto  =<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#aa1dba748c982e0759e1c13490a68ccf">get_trashdir</a>()+<span class="stringliteral">"/"</span>+<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#fdf2d9c2c13bfd05de4e7dad69ed5614">get_lastprefixnum_as_line</a>()+<span class="stringliteral">"_mytetra.xml"</span>;
<a name="l00632"></a>00632  <a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#f96423b10ba9101a88de147b1f4fe7bb">inc_lastprefixnum</a>();
<a name="l00633"></a>00633  qDebug() &lt;&lt; <span class="stringliteral">"Move file from "</span> &lt;&lt; filenamefrom &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; filenameto;
<a name="l00634"></a>00634  QFile::rename(filenamefrom,filenameto);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636  <span class="comment">// Запись DOM данных в файл</span>
<a name="l00637"></a>00637  QString filename=<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#3d61e98d919332ceb6acb2e03d8f848b">get_tetradir</a>()+<span class="stringliteral">"/mytetra.xml"</span>;
<a name="l00638"></a>00638  QFile wfile(filename);
<a name="l00639"></a>00639  <span class="keywordflow">if</span> (!wfile.open(QIODevice::WriteOnly | QIODevice::Text))
<a name="l00640"></a>00640   {
<a name="l00641"></a>00641    qDebug() &lt;&lt; <span class="stringliteral">"Cant open file "</span> &lt;&lt; filename &lt;&lt; <span class="stringliteral">" for write."</span>;
<a name="l00642"></a>00642    exit(1);
<a name="l00643"></a>00643   }
<a name="l00644"></a>00644  QTextStream out(&amp;wfile);
<a name="l00645"></a>00645  out.setCodec(<span class="stringliteral">"UTF-8"</span>);
<a name="l00646"></a>00646  out &lt;&lt; doc.toString();
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 
<a name="l00650"></a><a class="code" href="classtreescreen.html#acc87cede1cb206189394835bda06d3e">00650</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#acc87cede1cb206189394835bda06d3e">treescreen::update_selected_branch</a>(<span class="keywordtype">void</span>)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652  <span class="comment">// Получение списка выделенных Item-элементов</span>
<a name="l00653"></a>00653  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00654"></a>00654 
<a name="l00655"></a>00655  <span class="comment">// Обновление на экране</span>
<a name="l00656"></a>00656  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; selectitems.size(); ++i) 
<a name="l00657"></a>00657   <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;update(selectitems.at(i));
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 
<a name="l00661"></a><a class="code" href="classtreescreen.html#4319d9040f7721bd11f6defed0c3fbac">00661</a> QItemSelectionModel * <a class="code" href="classtreescreen.html#4319d9040f7721bd11f6defed0c3fbac">treescreen::get_selection_model</a>(<span class="keywordtype">void</span>)
<a name="l00662"></a>00662 {
<a name="l00663"></a>00663  <span class="keywordflow">return</span> <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel();
<a name="l00664"></a>00664 }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 
<a name="l00667"></a><a class="code" href="classtreescreen.html#c492316dfc6b272f474b267761962368">00667</a> <span class="keywordtype">void</span> <a class="code" href="classtreescreen.html#c492316dfc6b272f474b267761962368">treescreen::set_cursor_to_index</a>(QModelIndex index)
<a name="l00668"></a>00668 {
<a name="l00669"></a>00669  <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;setCurrentIndex(index,QItemSelectionModel::ClearAndSelect);
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672  
<a name="l00673"></a>00673 <span class="comment">// Получение номера первого выделенного элемента</span>
<a name="l00674"></a><a class="code" href="classtreescreen.html#c6214468c6db4e7aeada7a38ad51e727">00674</a> <span class="keywordtype">int</span> <a class="code" href="classtreescreen.html#c6214468c6db4e7aeada7a38ad51e727">treescreen::get_first_selected_item_index</a>(<span class="keywordtype">void</span>)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676  <span class="comment">// Получение списка выделенных Item-элементов</span>
<a name="l00677"></a>00677  QModelIndexList selectitems=<a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00678"></a>00678 
<a name="l00679"></a>00679  <span class="keywordflow">if</span>(selectitems.isEmpty())
<a name="l00680"></a>00680   <span class="keywordflow">return</span> -1; <span class="comment">// Если ничего не выделено</span>
<a name="l00681"></a>00681  <span class="keywordflow">else</span>
<a name="l00682"></a>00682   <span class="keywordflow">return</span> (selectitems.at(0)).row(); <span class="comment">// Индекс первого выделенного элемента</span>
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00685"></a>00685 
<a name="l00686"></a>00686 <span class="comment">// Получение индекса текущего элемента на котором стоит курсор</span>
<a name="l00687"></a><a class="code" href="classtreescreen.html#8b56108409028dc2c0996ac573fa7ff9">00687</a> QModelIndex <a class="code" href="classtreescreen.html#8b56108409028dc2c0996ac573fa7ff9">treescreen::get_current_item_index</a>(<span class="keywordtype">void</span>)
<a name="l00688"></a>00688 {
<a name="l00689"></a>00689  <span class="keywordflow">return</span> <a class="code" href="classtreescreen.html#784ae7066fc0dbbaea54f68ce648e3fe">knowtree</a>-&gt;selectionModel()-&gt;currentIndex();
<a name="l00690"></a>00690 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Feb 2 00:25:34 2009 for mytetra by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1 </small></address>
</body>
</html>
