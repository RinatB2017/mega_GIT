<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mytetra: recordtablescreen.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>recordtablescreen.cpp</h1><a href="recordtablescreen_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;QtCore/qobject.h&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;QtCore/qmimedata.h&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;QProgressBar&gt;</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include "<a class="code" href="main_8h.html">main.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="mainwindow_8h.html">mainwindow.h</a>"</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="clipbrecords_8h.html">clipbrecords.h</a>"</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include "<a class="code" href="recordtablescreen_8h.html">recordtablescreen.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="recordtablemodel_8h.html">recordtablemodel.h</a>"</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="keyword">extern</span> <a class="code" href="classappconfig.html">appconfig</a> <a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>;
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 
<a name="l00014"></a><a class="code" href="classrecordtablescreen.html#2542f57dfdd42389520d5f7d6963493f">00014</a> <a class="code" href="classrecordtablescreen.html#2542f57dfdd42389520d5f7d6963493f">recordtablescreen::recordtablescreen</a>(QWidget *parent) : QWidget(parent)
<a name="l00015"></a>00015 {
<a name="l00016"></a>00016  <a class="code" href="classrecordtablescreen.html#4e8f0ecaef3b8ea55c68ec06386b84ce">setup_actions</a>();
<a name="l00017"></a>00017  <a class="code" href="classrecordtablescreen.html#ce88d78bf51cbe1ebeb2515db80dece9">setup_ui</a>();
<a name="l00018"></a>00018 
<a name="l00019"></a>00019  <span class="comment">// Для вида таблицы данных устанавливается модель</span>
<a name="l00020"></a>00020  <span class="comment">// Установку модели надо сделать перед соединением сигналов и слотов</span>
<a name="l00021"></a>00021  <a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>=<span class="keyword">new</span> <a class="code" href="classrecordtablemodel.html">recordtablemodel</a>();
<a name="l00022"></a>00022  <a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;setObjectName(<span class="stringliteral">"recordmodel"</span>);
<a name="l00023"></a>00023  <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;setModel(<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>);
<a name="l00024"></a>00024  
<a name="l00025"></a>00025  <a class="code" href="classrecordtablescreen.html#63e5dbd8f4f958c226f79e422b0f17e3">setup_signals</a>();
<a name="l00026"></a>00026  <a class="code" href="classrecordtablescreen.html#ed6b3c5241560d8599f657586fe32b2b">assembly</a>();
<a name="l00027"></a>00027 
<a name="l00028"></a>00028  <a class="code" href="classrecordtablescreen.html#b7e9dbe44d4e786ac7aa1572990057d9">recordview_currentdir</a>=<span class="stringliteral">""</span>;
<a name="l00029"></a>00029  <a class="code" href="classrecordtablescreen.html#c95f81253a5ba51b15a9c2fdea58b436">recordview_currentfile</a>=<span class="stringliteral">""</span>;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031  <span class="comment">// Нужно установить правила показа контекстного самодельного меню</span>
<a name="l00032"></a>00032  <span class="comment">// чтобы оно могло вызываться</span>
<a name="l00033"></a>00033  <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;setContextMenuPolicy(Qt::CustomContextMenu);
<a name="l00034"></a>00034  
<a name="l00035"></a>00035 }
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="classrecordtablescreen.html#832d2a50320b57218eaa071b4692eb7f">00037</a> <a class="code" href="classrecordtablescreen.html#832d2a50320b57218eaa071b4692eb7f">recordtablescreen::~recordtablescreen</a>()
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="classrecordtablescreen.html#4e8f0ecaef3b8ea55c68ec06386b84ce">00043</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#4e8f0ecaef3b8ea55c68ec06386b84ce">recordtablescreen::setup_actions</a>(<span class="keywordtype">void</span>)
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045  <span class="comment">// Добавление записи</span>
<a name="l00046"></a>00046  <span class="comment">// a-&gt;setShortcut(tr("Ctrl+X"));</span>
<a name="l00047"></a>00047  <a class="code" href="classrecordtablescreen.html#755c98554622673eb9f70c0dff10074b">action_add_new_toend</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Add new"</span>), <span class="keyword">this</span>);
<a name="l00048"></a>00048  <a class="code" href="classrecordtablescreen.html#755c98554622673eb9f70c0dff10074b">action_add_new_toend</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Add new record"</span>));
<a name="l00049"></a>00049  <a class="code" href="classrecordtablescreen.html#755c98554622673eb9f70c0dff10074b">action_add_new_toend</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/note_add.svg"</span>));
<a name="l00050"></a>00050  connect(<a class="code" href="classrecordtablescreen.html#755c98554622673eb9f70c0dff10074b">action_add_new_toend</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#15da6524cadb2a7400e53d0c44476d63">add_new_toend_context</a>()));
<a name="l00051"></a>00051 
<a name="l00052"></a>00052  <span class="comment">// Добавление записи до</span>
<a name="l00053"></a>00053  <a class="code" href="classrecordtablescreen.html#6199377c78472f1c21b8ff6069f72c61">action_add_new_before</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Add new before"</span>), <span class="keyword">this</span>);
<a name="l00054"></a>00054  <a class="code" href="classrecordtablescreen.html#6199377c78472f1c21b8ff6069f72c61">action_add_new_before</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Add new record before selected record"</span>));
<a name="l00055"></a>00055  connect(<a class="code" href="classrecordtablescreen.html#6199377c78472f1c21b8ff6069f72c61">action_add_new_before</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#ace7ad1829e374ae71e8ca7121fa7607">add_new_before_context</a>()));
<a name="l00056"></a>00056 
<a name="l00057"></a>00057  <span class="comment">// Добавление записи после</span>
<a name="l00058"></a>00058  <a class="code" href="classrecordtablescreen.html#350b6410856141258b1d324686e26b09">action_add_new_after</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Add new after"</span>), <span class="keyword">this</span>);
<a name="l00059"></a>00059  <a class="code" href="classrecordtablescreen.html#350b6410856141258b1d324686e26b09">action_add_new_after</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Add new record after selected record"</span>));
<a name="l00060"></a>00060  connect(<a class="code" href="classrecordtablescreen.html#350b6410856141258b1d324686e26b09">action_add_new_after</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#22360e9ef1ec9a8ae665250a7cbbfb97">add_new_after_context</a>()));
<a name="l00061"></a>00061 
<a name="l00062"></a>00062  <span class="comment">// Редактирование записи</span>
<a name="l00063"></a>00063  <a class="code" href="classrecordtablescreen.html#3cbd66091b8a77cfa75ca9b61edc9f6f">action_edit_field</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Edit property (name, author, tags...)"</span>), <span class="keyword">this</span>);
<a name="l00064"></a>00064  <a class="code" href="classrecordtablescreen.html#3cbd66091b8a77cfa75ca9b61edc9f6f">action_edit_field</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Edit record property (name, author, tags...)"</span>));
<a name="l00065"></a>00065  <a class="code" href="classrecordtablescreen.html#3cbd66091b8a77cfa75ca9b61edc9f6f">action_edit_field</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/note_edit.svg"</span>));
<a name="l00066"></a>00066  connect(<a class="code" href="classrecordtablescreen.html#3cbd66091b8a77cfa75ca9b61edc9f6f">action_edit_field</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#5dd89302e35d464936f4492e8043204c">edit_field_context</a>()));
<a name="l00067"></a>00067 
<a name="l00068"></a>00068  <span class="comment">// Удаление записи</span>
<a name="l00069"></a>00069  <a class="code" href="classrecordtablescreen.html#fd4cb6265dd10d559f8d0244043dae42">action_delete</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Delete"</span>), <span class="keyword">this</span>);
<a name="l00070"></a>00070  <a class="code" href="classrecordtablescreen.html#fd4cb6265dd10d559f8d0244043dae42">action_delete</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Delete record(s)"</span>));
<a name="l00071"></a>00071  <a class="code" href="classrecordtablescreen.html#fd4cb6265dd10d559f8d0244043dae42">action_delete</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/note_delete.svg"</span>));
<a name="l00072"></a>00072  connect(<a class="code" href="classrecordtablescreen.html#fd4cb6265dd10d559f8d0244043dae42">action_delete</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#7112dde2ef63a21504b91061c6facd88">delete_context</a>()));
<a name="l00073"></a>00073 
<a name="l00074"></a>00074  <span class="comment">// Удаление записи с копированием в буфер обмена</span>
<a name="l00075"></a>00075  <a class="code" href="classrecordtablescreen.html#7c31f0fce3ad60ad8117b6954f9bd875">action_cut</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"&amp;Cut"</span>), <span class="keyword">this</span>);
<a name="l00076"></a>00076  <a class="code" href="classrecordtablescreen.html#7c31f0fce3ad60ad8117b6954f9bd875">action_cut</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Cut record(s) to clipboard"</span>));
<a name="l00077"></a>00077  <a class="code" href="classrecordtablescreen.html#7c31f0fce3ad60ad8117b6954f9bd875">action_cut</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/cb_cut.svg"</span>));
<a name="l00078"></a>00078  connect(<a class="code" href="classrecordtablescreen.html#7c31f0fce3ad60ad8117b6954f9bd875">action_cut</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#ff66fb349cc313a39b880a6a24d3a48f">cut</a>()));
<a name="l00079"></a>00079 
<a name="l00080"></a>00080  <span class="comment">// Копирование записи (записей) в буфер обмена</span>
<a name="l00081"></a>00081  <a class="code" href="classrecordtablescreen.html#7490f795a1262cf53d1f1e6455de0100">action_copy</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"&amp;Copy"</span>), <span class="keyword">this</span>);
<a name="l00082"></a>00082  <a class="code" href="classrecordtablescreen.html#7490f795a1262cf53d1f1e6455de0100">action_copy</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Copy record(s) to clipboard"</span>));
<a name="l00083"></a>00083  <a class="code" href="classrecordtablescreen.html#7490f795a1262cf53d1f1e6455de0100">action_copy</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/cb_copy.svg"</span>));
<a name="l00084"></a>00084  connect(<a class="code" href="classrecordtablescreen.html#7490f795a1262cf53d1f1e6455de0100">action_copy</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#b955b96193163a47680f3331c65a80e9">copy</a>()));
<a name="l00085"></a>00085 
<a name="l00086"></a>00086  <span class="comment">// Вставка записи из буфера обмена</span>
<a name="l00087"></a>00087  <a class="code" href="classrecordtablescreen.html#4a5328fc69bfc95fd33635bdd190da4a">action_paste</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"&amp;Paste"</span>), <span class="keyword">this</span>);
<a name="l00088"></a>00088  <a class="code" href="classrecordtablescreen.html#4a5328fc69bfc95fd33635bdd190da4a">action_paste</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Paste record(s) from clipboard"</span>));
<a name="l00089"></a>00089  <a class="code" href="classrecordtablescreen.html#4a5328fc69bfc95fd33635bdd190da4a">action_paste</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/cb_paste.svg"</span>));
<a name="l00090"></a>00090  connect(<a class="code" href="classrecordtablescreen.html#4a5328fc69bfc95fd33635bdd190da4a">action_paste</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#247769a42808ec37995b4609d7c1750e">paste</a>()));
<a name="l00091"></a>00091 
<a name="l00092"></a>00092  <span class="comment">// Перемещение записи вверх</span>
<a name="l00093"></a>00093  <a class="code" href="classrecordtablescreen.html#30cf00f9d33ba2dba680f9674abe5671">action_moveup</a> = <span class="keyword">new</span> QAction(tr(<span class="stringliteral">"&amp;Move Up"</span>), <span class="keyword">this</span>);
<a name="l00094"></a>00094  <a class="code" href="classrecordtablescreen.html#30cf00f9d33ba2dba680f9674abe5671">action_moveup</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Move record up"</span>));
<a name="l00095"></a>00095  <a class="code" href="classrecordtablescreen.html#30cf00f9d33ba2dba680f9674abe5671">action_moveup</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/move_up.svg"</span>));
<a name="l00096"></a>00096  connect(<a class="code" href="classrecordtablescreen.html#30cf00f9d33ba2dba680f9674abe5671">action_moveup</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#732e2c379f2a1149023965f1c62fab05">moveup</a>()));
<a name="l00097"></a>00097 
<a name="l00098"></a>00098  <span class="comment">// Перемещение записи вниз</span>
<a name="l00099"></a>00099  <a class="code" href="classrecordtablescreen.html#ccdcdeffdc381b2bdf2d8f550816d4ac">action_movedn</a>=<span class="keyword">new</span> QAction(tr(<span class="stringliteral">"&amp;Move Down"</span>), <span class="keyword">this</span>);
<a name="l00100"></a>00100  <a class="code" href="classrecordtablescreen.html#ccdcdeffdc381b2bdf2d8f550816d4ac">action_movedn</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Move record down"</span>));
<a name="l00101"></a>00101  <a class="code" href="classrecordtablescreen.html#ccdcdeffdc381b2bdf2d8f550816d4ac">action_movedn</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/move_dn.svg"</span>));
<a name="l00102"></a>00102  connect(<a class="code" href="classrecordtablescreen.html#ccdcdeffdc381b2bdf2d8f550816d4ac">action_movedn</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#fc3e465b3266eb01ee0a1f95839f7edd">movedn</a>()));
<a name="l00103"></a>00103 
<a name="l00104"></a>00104  <a class="code" href="classrecordtablescreen.html#5a75aaa4075022b193223603475aaef0">action_findinbase</a>=<span class="keyword">new</span> QAction(tr(<span class="stringliteral">"Find in base"</span>), <span class="keyword">this</span>);
<a name="l00105"></a>00105  <a class="code" href="classrecordtablescreen.html#5a75aaa4075022b193223603475aaef0">action_findinbase</a>-&gt;setStatusTip(tr(<span class="stringliteral">"Find in base"</span>));
<a name="l00106"></a>00106  <a class="code" href="classrecordtablescreen.html#5a75aaa4075022b193223603475aaef0">action_findinbase</a>-&gt;setIcon(QIcon(<span class="stringliteral">"resource/pic/find_in_base.svg"</span>));
<a name="l00107"></a>00107  connect(<a class="code" href="classrecordtablescreen.html#5a75aaa4075022b193223603475aaef0">action_findinbase</a>, SIGNAL(triggered()), <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#2b14a42da565396ee402c9cf1046c00c">findinbase_open</a>()));
<a name="l00108"></a>00108   
<a name="l00109"></a>00109  <span class="comment">// Сразу после создания все действия запрещены</span>
<a name="l00110"></a>00110  <a class="code" href="classrecordtablescreen.html#29e17faab1f97b595f897d80c287f92d">disable_all_actions</a>();
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="classrecordtablescreen.html#ce88d78bf51cbe1ebeb2515db80dece9">00114</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#ce88d78bf51cbe1ebeb2515db80dece9">recordtablescreen::setup_ui</a>(<span class="keywordtype">void</span>)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>=<span class="keyword">new</span> QToolBar(<span class="keyword">this</span>);
<a name="l00117"></a>00117  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addSeparator();
<a name="l00118"></a>00118  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#755c98554622673eb9f70c0dff10074b">action_add_new_toend</a>);
<a name="l00119"></a>00119  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#3cbd66091b8a77cfa75ca9b61edc9f6f">action_edit_field</a>);
<a name="l00120"></a>00120  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#fd4cb6265dd10d559f8d0244043dae42">action_delete</a>);
<a name="l00121"></a>00121  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addSeparator();
<a name="l00122"></a>00122  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#7c31f0fce3ad60ad8117b6954f9bd875">action_cut</a>);
<a name="l00123"></a>00123  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#7490f795a1262cf53d1f1e6455de0100">action_copy</a>);
<a name="l00124"></a>00124  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#4a5328fc69bfc95fd33635bdd190da4a">action_paste</a>);
<a name="l00125"></a>00125  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addSeparator();
<a name="l00126"></a>00126  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#30cf00f9d33ba2dba680f9674abe5671">action_moveup</a>);
<a name="l00127"></a>00127  <a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#ccdcdeffdc381b2bdf2d8f550816d4ac">action_movedn</a>);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129  <a class="code" href="classrecordtablescreen.html#79b4c677242dc0bbbf118bc7674c9d39">find_line</a>=<span class="keyword">new</span> QToolBar(<span class="keyword">this</span>);
<a name="l00130"></a>00130  <a class="code" href="classrecordtablescreen.html#79b4c677242dc0bbbf118bc7674c9d39">find_line</a>-&gt;addAction(<a class="code" href="classrecordtablescreen.html#5a75aaa4075022b193223603475aaef0">action_findinbase</a>);
<a name="l00131"></a>00131  
<a name="l00132"></a>00132  <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>=<span class="keyword">new</span> QListView(<span class="keyword">this</span>);
<a name="l00133"></a>00133  <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;setObjectName(<span class="stringliteral">"recordview"</span>);
<a name="l00134"></a>00134  <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;setSelectionMode(QAbstractItemView::ExtendedSelection);
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="classrecordtablescreen.html#63e5dbd8f4f958c226f79e422b0f17e3">00138</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#63e5dbd8f4f958c226f79e422b0f17e3">recordtablescreen::setup_signals</a>(<span class="keywordtype">void</span>)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140  <span class="comment">// Сигнал чтобы показать контекстное меню по правому клику на списке записей</span>
<a name="l00141"></a>00141  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>,SIGNAL(customContextMenuRequested(<span class="keyword">const</span> QPoint &amp;)),
<a name="l00142"></a>00142          <span class="keyword">this</span>,SLOT(<a class="code" href="classrecordtablescreen.html#4d456453a98a1cda55cf374d4178f6a8">on_customContextMenuRequested</a>(<span class="keyword">const</span> QPoint &amp;)));
<a name="l00143"></a>00143 
<a name="l00144"></a>00144  <span class="comment">// Сигнал чтобы открыть на редактирование параметры записи при двойном клике</span>
<a name="l00145"></a>00145  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>, SIGNAL(doubleClicked(<span class="keyword">const</span> QModelIndex &amp;)),
<a name="l00146"></a>00146          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#5dd89302e35d464936f4492e8043204c">edit_field_context</a>(<span class="keywordtype">void</span>)));
<a name="l00147"></a>00147 
<a name="l00148"></a>00148  <span class="comment">// Сигнал для обработки движения стрелок в списке конечных записей</span>
<a name="l00149"></a>00149  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel(), SIGNAL(currentRowChanged (<span class="keyword">const</span> QModelIndex&amp;, <span class="keyword">const</span> QModelIndex&amp;)),
<a name="l00150"></a>00150          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#55bc3b168d846297e2107ea29ee24f7a">select</a>(<span class="keyword">const</span> QModelIndex&amp;)));
<a name="l00151"></a>00151 
<a name="l00152"></a>00152  <span class="comment">// Сигналы для обновления панели инструментов при изменении в selectionModel()</span>
<a name="l00153"></a>00153  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel(), SIGNAL(currentChanged (<span class="keyword">const</span> QModelIndex&amp;, <span class="keyword">const</span> QModelIndex&amp;)),
<a name="l00154"></a>00154          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">tools_update</a>(<span class="keywordtype">void</span>)));
<a name="l00155"></a>00155  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel(), SIGNAL(selectionChanged (<span class="keyword">const</span> QItemSelection&amp;, <span class="keyword">const</span> QItemSelection&amp;)),
<a name="l00156"></a>00156          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">tools_update</a>(<span class="keywordtype">void</span>)));
<a name="l00157"></a>00157 
<a name="l00158"></a>00158  <span class="comment">// Сигналы для обновления панели инструментов</span>
<a name="l00159"></a>00159  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>, SIGNAL(activated(<span class="keyword">const</span> QModelIndex &amp;)),
<a name="l00160"></a>00160          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">tools_update</a>(<span class="keywordtype">void</span>)));
<a name="l00161"></a>00161  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>, SIGNAL(clicked(<span class="keyword">const</span> QModelIndex &amp;)),
<a name="l00162"></a>00162          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">tools_update</a>(<span class="keywordtype">void</span>)));
<a name="l00163"></a>00163  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>, SIGNAL(doubleClicked(<span class="keyword">const</span> QModelIndex &amp;)),
<a name="l00164"></a>00164          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">tools_update</a>(<span class="keywordtype">void</span>)));
<a name="l00165"></a>00165  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>, SIGNAL(entered(<span class="keyword">const</span> QModelIndex &amp;)),
<a name="l00166"></a>00166          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">tools_update</a>(<span class="keywordtype">void</span>)));
<a name="l00167"></a>00167  connect(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>, SIGNAL(pressed(<span class="keyword">const</span> QModelIndex &amp;)),
<a name="l00168"></a>00168          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">tools_update</a>(<span class="keywordtype">void</span>)));
<a name="l00169"></a>00169  connect(QApplication::clipboard(),SIGNAL(dataChanged()),
<a name="l00170"></a>00170          <span class="keyword">this</span>, SLOT(<a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">tools_update</a>(<span class="keywordtype">void</span>)));
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="classrecordtablescreen.html#ed6b3c5241560d8599f657586fe32b2b">00174</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#ed6b3c5241560d8599f657586fe32b2b">recordtablescreen::assembly</a>(<span class="keywordtype">void</span>)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176  <a class="code" href="classrecordtablescreen.html#7f35fe695ed9bf611d5c75a33e61693f">recordtable_tools_layout</a>=<span class="keyword">new</span> QHBoxLayout();
<a name="l00177"></a>00177  <a class="code" href="classrecordtablescreen.html#7f35fe695ed9bf611d5c75a33e61693f">recordtable_tools_layout</a>-&gt;addWidget(<a class="code" href="classrecordtablescreen.html#4d12482b6d9a926f84b8095c1ca37683">tools_line</a>);
<a name="l00178"></a>00178  <a class="code" href="classrecordtablescreen.html#7f35fe695ed9bf611d5c75a33e61693f">recordtable_tools_layout</a>-&gt;addStretch();
<a name="l00179"></a>00179  <a class="code" href="classrecordtablescreen.html#7f35fe695ed9bf611d5c75a33e61693f">recordtable_tools_layout</a>-&gt;addWidget(<a class="code" href="classrecordtablescreen.html#79b4c677242dc0bbbf118bc7674c9d39">find_line</a>);
<a name="l00180"></a>00180  
<a name="l00181"></a>00181  <a class="code" href="classrecordtablescreen.html#7b65632d6fef4bd862e49ab1ec44846d">recordtablescreen_layout</a>=<span class="keyword">new</span> QVBoxLayout();
<a name="l00182"></a>00182  <a class="code" href="classrecordtablescreen.html#7b65632d6fef4bd862e49ab1ec44846d">recordtablescreen_layout</a>-&gt;setObjectName(<span class="stringliteral">"recordtablescreen_QVBoxLayout"</span>);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184  <a class="code" href="classrecordtablescreen.html#7b65632d6fef4bd862e49ab1ec44846d">recordtablescreen_layout</a>-&gt;addLayout(<a class="code" href="classrecordtablescreen.html#7f35fe695ed9bf611d5c75a33e61693f">recordtable_tools_layout</a>);
<a name="l00185"></a>00185  <a class="code" href="classrecordtablescreen.html#7b65632d6fef4bd862e49ab1ec44846d">recordtablescreen_layout</a>-&gt;addWidget(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>);
<a name="l00186"></a>00186 
<a name="l00187"></a>00187  setLayout(<a class="code" href="classrecordtablescreen.html#7b65632d6fef4bd862e49ab1ec44846d">recordtablescreen_layout</a>);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189  <span class="comment">// Границы убираются, так как данный объект будет использоваться как виджет</span>
<a name="l00190"></a>00190  QLayout *lt;
<a name="l00191"></a>00191  lt=layout();
<a name="l00192"></a>00192  lt-&gt;setContentsMargins(0,2,0,0);
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="comment">// Установка нового набора данных для списка записей</span>
<a name="l00197"></a><a class="code" href="classrecordtablescreen.html#e1572a908c5e8c72af3ed0000375e2dd">00197</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#e1572a908c5e8c72af3ed0000375e2dd">recordtablescreen::set_tabledata</a>(<a class="code" href="classrecordtabledata.html">recordtabledata</a> *rtdata)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199  qDebug() &lt;&lt; <span class="stringliteral">"In recordtablescreen set_tabledata() start"</span>;
<a name="l00200"></a>00200  
<a name="l00201"></a>00201  <span class="comment">// Обновление набора данных с последующим выбором первой строки</span>
<a name="l00202"></a>00202  <span class="comment">// может быть очень длительным, поэтому показывается что процесс выполняется</span>
<a name="l00203"></a>00203  <span class="comment">// QCursor cursor_wait=QCursor(Qt::BusyCursor);</span>
<a name="l00204"></a>00204  <span class="comment">// qApp-&gt;setOverrideCursor(cursor_wait);</span>
<a name="l00205"></a>00205  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;setCursor(Qt::BusyCursor);
<a name="l00206"></a>00206  
<a name="l00207"></a>00207  <span class="comment">// Указатель на данные сообщается источнику данных</span>
<a name="l00208"></a>00208  <a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#c7525d3fce71b4ad225169190141088f">set_tabledata</a>(rtdata);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210  <span class="comment">// Надо обязательно сбросить selection model для списка записей</span>
<a name="l00211"></a>00211  <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;clear();
<a name="l00212"></a>00212  
<a name="l00213"></a>00213  <span class="comment">// Если список конечных записей не пуст</span>
<a name="l00214"></a>00214  <span class="comment">// Выделение надо устанавливается на первую запись</span>
<a name="l00215"></a>00215  <span class="comment">// иначе выделение устанавливать ненужно, </span>
<a name="l00216"></a>00216  <span class="comment">// а надо очистить поля области редактировния</span>
<a name="l00217"></a>00217  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#d243937a7c319b06445655687347bfa0">rowCount</a>()&gt;0)
<a name="l00218"></a>00218   <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;setCurrentIndex( <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;model()-&gt;index( 0, 0 ) , QItemSelectionModel::SelectCurrent);
<a name="l00219"></a>00219  <span class="keywordflow">else</span>
<a name="l00220"></a>00220  { 
<a name="l00221"></a>00221   find_object&lt;metaeditor&gt;(<span class="stringliteral">"editorview"</span>)-&gt;clear_all();
<a name="l00222"></a>00222   <a class="code" href="classrecordtablescreen.html#b7e9dbe44d4e786ac7aa1572990057d9">recordview_currentdir</a>=<span class="stringliteral">""</span>;
<a name="l00223"></a>00223   <a class="code" href="classrecordtablescreen.html#c95f81253a5ba51b15a9c2fdea58b436">recordview_currentfile</a>=<span class="stringliteral">""</span>;
<a name="l00224"></a>00224  }
<a name="l00225"></a>00225  
<a name="l00226"></a>00226  <span class="comment">// qApp-&gt;restoreOverrideCursor();</span>
<a name="l00227"></a>00227  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;unsetCursor();
<a name="l00228"></a>00228  
<a name="l00229"></a>00229  qDebug() &lt;&lt; <span class="stringliteral">"In recordtablescreen set new model stop"</span>;
<a name="l00230"></a>00230 }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 
<a name="l00233"></a><a class="code" href="classrecordtablescreen.html#5f419b091a8911fa8be695b6c5956e7e">00233</a> QString <a class="code" href="classrecordtablescreen.html#5f419b091a8911fa8be695b6c5956e7e">recordtablescreen::get_currentdir</a>(<span class="keywordtype">void</span>)
<a name="l00234"></a>00234 {
<a name="l00235"></a>00235  <span class="keywordflow">return</span> <a class="code" href="classrecordtablescreen.html#b7e9dbe44d4e786ac7aa1572990057d9">recordview_currentdir</a>;
<a name="l00236"></a>00236 }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="classrecordtablescreen.html#e7502491e7959dc271a55ed39d255a9d">00239</a> QString <a class="code" href="classrecordtablescreen.html#e7502491e7959dc271a55ed39d255a9d">recordtablescreen::get_currentfile</a>(<span class="keywordtype">void</span>)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241  <span class="keywordflow">return</span> <a class="code" href="classrecordtablescreen.html#c95f81253a5ba51b15a9c2fdea58b436">recordview_currentfile</a>;
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="comment">// Полный путь к файлу, который открыт на редактирование в recordview</span>
<a name="l00246"></a><a class="code" href="classrecordtablescreen.html#a3fac56820514280445d9ef0de9f1632">00246</a> QString <a class="code" href="classrecordtablescreen.html#a3fac56820514280445d9ef0de9f1632">recordtablescreen::get_fullfilename_of_currentitem</a>(<span class="keywordtype">void</span>)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248  QString fullfilename=<span class="stringliteral">"./"</span>+<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#3d61e98d919332ceb6acb2e03d8f848b">get_tetradir</a>()+<span class="stringliteral">"/base/"</span>+<a class="code" href="classrecordtablescreen.html#b7e9dbe44d4e786ac7aa1572990057d9">recordview_currentdir</a>+<span class="stringliteral">"/"</span>+<a class="code" href="classrecordtablescreen.html#c95f81253a5ba51b15a9c2fdea58b436">recordview_currentfile</a>;
<a name="l00249"></a>00249  <span class="keywordflow">return</span> fullfilename;
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 <span class="comment">// Действия при выборе пункта таблицы конечных записей</span>
<a name="l00254"></a><a class="code" href="classrecordtablescreen.html#55bc3b168d846297e2107ea29ee24f7a">00254</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#55bc3b168d846297e2107ea29ee24f7a">recordtablescreen::select</a>(<span class="keyword">const</span> QModelIndex &amp;index)
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256  qDebug() &lt;&lt; <span class="stringliteral">"In function recordtablescreen select () current item num "</span> &lt;&lt; index.row();
<a name="l00257"></a>00257 
<a name="l00258"></a>00258  <span class="comment">// Сохраняется текст в окне редактирования в соответсвующий файл</span>
<a name="l00259"></a>00259  find_object&lt;mainwindow&gt;(<span class="stringliteral">"mainwindow"</span>)-&gt;save_current_record_text();
<a name="l00260"></a>00260 
<a name="l00261"></a>00261  <span class="comment">// Выясняется ссылка на таблицу конечных данных</span>
<a name="l00262"></a>00262  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *table=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e3a0df4eed2846f73e7858e27ce3fdb6">get_tabledata</a>();
<a name="l00263"></a>00263  
<a name="l00264"></a>00264  <span class="comment">// Для новой выбраной записи выясняется директория и основной файл</span>
<a name="l00265"></a>00265  QString currentdir =table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"dir"</span>,index.row());
<a name="l00266"></a>00266  QString currentfile=table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"file"</span>,index.row());
<a name="l00267"></a>00267  QString fullfilename=<span class="stringliteral">"./"</span>+<a class="code" href="findscreen_8cpp.html#69bd0a7d678d494effdef51808501712">mytetraconfig</a>.<a class="code" href="classappconfig.html#3d61e98d919332ceb6acb2e03d8f848b">get_tetradir</a>()+<span class="stringliteral">"/base/"</span>+currentdir+<span class="stringliteral">"/"</span>+currentfile;
<a name="l00268"></a>00268  qDebug() &lt;&lt; <span class="stringliteral">" File "</span> &lt;&lt; fullfilename &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00269"></a>00269  QFile f(fullfilename);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271  <span class="comment">// Если в окне содержимого записи уже находится выбираемая запись</span>
<a name="l00272"></a>00272  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#b7e9dbe44d4e786ac7aa1572990057d9">recordview_currentdir</a>==currentdir &amp;&amp; 
<a name="l00273"></a>00273     <a class="code" href="classrecordtablescreen.html#c95f81253a5ba51b15a9c2fdea58b436">recordview_currentfile</a>==currentfile) <span class="keywordflow">return</span>;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275  <span class="comment">// Если нужный файл не существует</span>
<a name="l00276"></a>00276  <span class="keywordflow">if</span>(!f.exists())
<a name="l00277"></a>00277   <a class="code" href="main_8cpp.html#fe5e42a76086b3d9d2912f0c17ef0e59">critical_error</a>(<span class="stringliteral">"File "</span>+fullfilename+<span class="stringliteral">" not found"</span>);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279  <span class="comment">// Если нужный файл недоступен для чтения</span>
<a name="l00280"></a>00280  <span class="keywordflow">if</span>(!f.open(QIODevice::ReadOnly))
<a name="l00281"></a>00281   <a class="code" href="main_8cpp.html#fe5e42a76086b3d9d2912f0c17ef0e59">critical_error</a>(<span class="stringliteral">"File "</span>+fullfilename+<span class="stringliteral">" not readable. Check permission."</span>);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
<a name="l00284"></a>00284  <span class="comment">// Текст из файла вставляется в окно редактирования</span>
<a name="l00285"></a>00285  <span class="comment">// editorview-&gt;set_textarea( QString::fromUtf8(f.readAll()) );</span>
<a name="l00286"></a>00286  <a class="code" href="classmetaeditor.html">metaeditor</a> *edview=find_object&lt;metaeditor&gt;(<span class="stringliteral">"editorview"</span>);
<a name="l00287"></a>00287  edview-&gt;<a class="code" href="classeditor.html#f106cccf403b250d3356757f8c2e00b3">set_textarea</a>( QString::fromUtf8(f.readAll()) );
<a name="l00288"></a>00288 
<a name="l00289"></a>00289  <span class="comment">// Заполнятся прочие инфо поля на экране</span>
<a name="l00290"></a>00290  edview-&gt;<a class="code" href="classmetaeditor.html#209a7a5bd42af050a9fb55c6c8948ce4">set_name</a>  ( table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"name"</span>,index.row()) );
<a name="l00291"></a>00291  edview-&gt;<a class="code" href="classmetaeditor.html#4703d66561c6c4e45d356a107b435124">set_author</a>( table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"author"</span>,index.row()) );
<a name="l00292"></a>00292  edview-&gt;<a class="code" href="classmetaeditor.html#02edd9b23f915125e2b07fb5c6b4dbc7">set_url</a>   ( table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"url"</span>,index.row()) );
<a name="l00293"></a>00293  edview-&gt;<a class="code" href="classmetaeditor.html#edf5c4b69e3a2fb3b6dbf6d629fd11ff">set_tags</a>  ( table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"tags"</span>,index.row()) );
<a name="l00294"></a>00294 
<a name="l00295"></a>00295  <span class="comment">// Запоминаются имя файла и директории</span>
<a name="l00296"></a>00296  <a class="code" href="classrecordtablescreen.html#b7e9dbe44d4e786ac7aa1572990057d9">recordview_currentdir</a>=currentdir;
<a name="l00297"></a>00297  <a class="code" href="classrecordtablescreen.html#c95f81253a5ba51b15a9c2fdea58b436">recordview_currentfile</a>=currentfile;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="comment">// Слот для вызова добавления новой записи в конец таблицы</span>
<a name="l00302"></a><a class="code" href="classrecordtablescreen.html#15da6524cadb2a7400e53d0c44476d63">00302</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#15da6524cadb2a7400e53d0c44476d63">recordtablescreen::add_new_toend_context</a>(<span class="keywordtype">void</span>)
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304  qDebug() &lt;&lt; <span class="stringliteral">"In slot add_new_toend_context()"</span>;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306  <a class="code" href="classrecordtablescreen.html#e52ce4d7625ab4d1a78938b3028652be">add_new_record</a>(<a class="code" href="mainwindow_8h.html#3ff28b5932200d5e6cac920029f0df0d">ADD_NEW_RECORD_TO_END</a>);
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 <span class="comment">// Слот для вызова добавления новой записи перед выделенной строкой</span>
<a name="l00311"></a><a class="code" href="classrecordtablescreen.html#ace7ad1829e374ae71e8ca7121fa7607">00311</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#ace7ad1829e374ae71e8ca7121fa7607">recordtablescreen::add_new_before_context</a>(<span class="keywordtype">void</span>)
<a name="l00312"></a>00312 {
<a name="l00313"></a>00313  qDebug() &lt;&lt; <span class="stringliteral">"In slot add_new_before_context()"</span>;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315  <a class="code" href="classrecordtablescreen.html#e52ce4d7625ab4d1a78938b3028652be">add_new_record</a>(<a class="code" href="mainwindow_8h.html#a265280e56bf1f4bf9309e95c12d0980">ADD_NEW_RECORD_BEFORE</a>);
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="comment">// Слот для вызова добавления новой записи после выделенной строки</span>
<a name="l00320"></a><a class="code" href="classrecordtablescreen.html#22360e9ef1ec9a8ae665250a7cbbfb97">00320</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#22360e9ef1ec9a8ae665250a7cbbfb97">recordtablescreen::add_new_after_context</a>(<span class="keywordtype">void</span>)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322  qDebug() &lt;&lt; <span class="stringliteral">"In slot add_new_after_context()"</span>;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324  <a class="code" href="classrecordtablescreen.html#e52ce4d7625ab4d1a78938b3028652be">add_new_record</a>(<a class="code" href="mainwindow_8h.html#3850518597a1aac6ea8540bdb4dbc7ff">ADD_NEW_RECORD_AFTER</a>);
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 <span class="comment">// Вызов окна добавления данных в таблицу конечных записей</span>
<a name="l00329"></a><a class="code" href="classrecordtablescreen.html#e52ce4d7625ab4d1a78938b3028652be">00329</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#e52ce4d7625ab4d1a78938b3028652be">recordtablescreen::add_new_record</a>(<span class="keywordtype">int</span> mode)
<a name="l00330"></a>00330 {
<a name="l00331"></a>00331  qDebug() &lt;&lt; <span class="stringliteral">"In add_new_record()"</span>;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333  <span class="comment">// Создается окно ввода данных, после выхода из этой функции окно должно удалиться</span>
<a name="l00334"></a>00334  <a class="code" href="classaddnewrecord.html">addnewrecord</a> addnewrecordwin;
<a name="l00335"></a>00335  <span class="keywordtype">int</span> i=addnewrecordwin.exec();
<a name="l00336"></a>00336  <span class="keywordflow">if</span>(i==QDialog::Rejected)<span class="keywordflow">return</span>; <span class="comment">// Была нажата отмена, ничего ненужно делать</span>
<a name="l00337"></a>00337 
<a name="l00338"></a>00338  <span class="comment">// Введенные данные добавляются</span>
<a name="l00339"></a>00339  <a class="code" href="classrecordtablescreen.html#e3e3b5770bfdb550262ff4dab723599a">add_new</a>(mode,
<a name="l00340"></a>00340          addnewrecordwin.<a class="code" href="classaddnewrecord.html#b17a7bac9ffb0b9474e0c5a50eecd958">get_field</a>(<span class="stringliteral">"name"</span>),
<a name="l00341"></a>00341          addnewrecordwin.<a class="code" href="classaddnewrecord.html#b17a7bac9ffb0b9474e0c5a50eecd958">get_field</a>(<span class="stringliteral">"author"</span>),
<a name="l00342"></a>00342          addnewrecordwin.<a class="code" href="classaddnewrecord.html#b17a7bac9ffb0b9474e0c5a50eecd958">get_field</a>(<span class="stringliteral">"url"</span>),
<a name="l00343"></a>00343          addnewrecordwin.<a class="code" href="classaddnewrecord.html#b17a7bac9ffb0b9474e0c5a50eecd958">get_field</a>(<span class="stringliteral">"tags"</span>),
<a name="l00344"></a>00344          addnewrecordwin.<a class="code" href="classaddnewrecord.html#b17a7bac9ffb0b9474e0c5a50eecd958">get_field</a>(<span class="stringliteral">"text"</span>));
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 <span class="comment">// Функция добавления новой записи в таблицу конечных записей</span>
<a name="l00349"></a><a class="code" href="classrecordtablescreen.html#e3e3b5770bfdb550262ff4dab723599a">00349</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#e3e3b5770bfdb550262ff4dab723599a">recordtablescreen::add_new</a>(<span class="keywordtype">int</span> mode,
<a name="l00350"></a>00350                                 QString name,
<a name="l00351"></a>00351                                 QString author,
<a name="l00352"></a>00352                                 QString url,
<a name="l00353"></a>00353                                 QString tags,
<a name="l00354"></a>00354                                 QString text)
<a name="l00355"></a>00355 {
<a name="l00356"></a>00356  qDebug() &lt;&lt; <span class="stringliteral">"In add_new()"</span>;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358  <span class="comment">// Получение номера первой выделенной строки</span>
<a name="l00359"></a>00359  <span class="keywordtype">int</span> pos=<a class="code" href="classrecordtablescreen.html#edf8ac561d0f33acf6af0fe63fbc8a91">get_first_selection_pos</a>();
<a name="l00360"></a>00360  <span class="keywordflow">if</span>(pos&lt;0)pos=0; <span class="comment">// Если ничего небыло выбрано</span>
<a name="l00361"></a>00361 
<a name="l00362"></a>00362  <span class="comment">// Выясняется ссылка на таблицу конечных данных</span>
<a name="l00363"></a>00363  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *table=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e3a0df4eed2846f73e7858e27ce3fdb6">get_tabledata</a>();
<a name="l00364"></a>00364 
<a name="l00365"></a>00365  <span class="comment">// Вставка новых данных в модель таблицы конечных записей</span>
<a name="l00366"></a>00366  <span class="keywordtype">int</span> selpos=table-&gt;<a class="code" href="classrecordtabledata.html#15f519acd76fc58f882e5a5d78105c61">insert_new_record</a>(mode,pos,
<a name="l00367"></a>00367                                      name,
<a name="l00368"></a>00368                                      author,
<a name="l00369"></a>00369                                      url,
<a name="l00370"></a>00370                                      tags,
<a name="l00371"></a>00371                                      text);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373  <span class="comment">// Обновление данных на экране после их изменения</span>
<a name="l00374"></a>00374  <a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e19a2f856cd1dda4f1955af3544ce482">update</a>();
<a name="l00375"></a>00375  
<a name="l00376"></a>00376  <span class="comment">// Установка курсора на только что созданную позицию</span>
<a name="l00377"></a>00377  QModelIndex selidx=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;index(selpos); <span class="comment">// Создание индекса из номера</span>
<a name="l00378"></a>00378  <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;setCurrentIndex(selidx,QItemSelectionModel::ClearAndSelect);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380  <span class="comment">// Сохранение дерева веток</span>
<a name="l00381"></a>00381  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;save_knowtree();
<a name="l00382"></a>00382 }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 
<a name="l00385"></a><a class="code" href="classrecordtablescreen.html#5dd89302e35d464936f4492e8043204c">00385</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#5dd89302e35d464936f4492e8043204c">recordtablescreen::edit_field_context</a>(<span class="keywordtype">void</span>)
<a name="l00386"></a>00386 {
<a name="l00387"></a>00387  qDebug() &lt;&lt; <span class="stringliteral">"In edit_field_context()"</span>;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389  <span class="comment">// Получение индекса выделенного элемента</span>
<a name="l00390"></a>00390  QModelIndexList selectitems=<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00391"></a>00391  QModelIndex index=selectitems.at(0);
<a name="l00392"></a>00392  <span class="keywordtype">int</span> pos=(selectitems.at(0)).row();
<a name="l00393"></a>00393 
<a name="l00394"></a>00394  <span class="comment">// Создается окно ввода данных, после выхода из этой функции окно должно удалиться</span>
<a name="l00395"></a>00395  <a class="code" href="classeditrecord.html">editrecord</a> editrecordwin;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397   <span class="comment">// Выясняется ссылка на таблицу конечных данных</span>
<a name="l00398"></a>00398  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *table=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e3a0df4eed2846f73e7858e27ce3fdb6">get_tabledata</a>();
<a name="l00399"></a>00399 
<a name="l00400"></a>00400  <span class="comment">// Поля окна заполняются начальными значениями</span>
<a name="l00401"></a>00401  editrecordwin.<a class="code" href="classeditrecord.html#7e6e9990768cb64f0e73e3f7b94fa5a1">set_field</a>(<span class="stringliteral">"name"</span>,  table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"name"</span>,index.row()) );
<a name="l00402"></a>00402  editrecordwin.<a class="code" href="classeditrecord.html#7e6e9990768cb64f0e73e3f7b94fa5a1">set_field</a>(<span class="stringliteral">"author"</span>,table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"author"</span>,index.row()) );
<a name="l00403"></a>00403  editrecordwin.<a class="code" href="classeditrecord.html#7e6e9990768cb64f0e73e3f7b94fa5a1">set_field</a>(<span class="stringliteral">"url"</span>,   table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"url"</span>,index.row()) );
<a name="l00404"></a>00404  editrecordwin.<a class="code" href="classeditrecord.html#7e6e9990768cb64f0e73e3f7b94fa5a1">set_field</a>(<span class="stringliteral">"tags"</span>,  table-&gt;<a class="code" href="classrecordtabledata.html#1e5d2effed44a3b5c2072f570cf02594">get_field</a>(<span class="stringliteral">"tags"</span>,index.row()) );
<a name="l00405"></a>00405 
<a name="l00406"></a>00406 
<a name="l00407"></a>00407  <span class="keywordtype">int</span> i=editrecordwin.exec();
<a name="l00408"></a>00408  <span class="keywordflow">if</span>(i==QDialog::Rejected)<span class="keywordflow">return</span>; <span class="comment">// Была нажата отмена, ничего ненужно делать</span>
<a name="l00409"></a>00409 
<a name="l00410"></a>00410  <span class="comment">// Введенные данные обновляются</span>
<a name="l00411"></a>00411  <a class="code" href="classrecordtablescreen.html#41863650780dd07b0fc1275f748f78b4">edit_field</a>(pos,
<a name="l00412"></a>00412             editrecordwin.<a class="code" href="classeditrecord.html#07fa56843727ad158ae073c9b40909e6">get_field</a>(<span class="stringliteral">"name"</span>),
<a name="l00413"></a>00413             editrecordwin.<a class="code" href="classeditrecord.html#07fa56843727ad158ae073c9b40909e6">get_field</a>(<span class="stringliteral">"author"</span>),
<a name="l00414"></a>00414             editrecordwin.<a class="code" href="classeditrecord.html#07fa56843727ad158ae073c9b40909e6">get_field</a>(<span class="stringliteral">"url"</span>),
<a name="l00415"></a>00415             editrecordwin.<a class="code" href="classeditrecord.html#07fa56843727ad158ae073c9b40909e6">get_field</a>(<span class="stringliteral">"tags"</span>));
<a name="l00416"></a>00416 
<a name="l00417"></a>00417  <span class="comment">// Нужно перерисовать окно редактирования чтобы обновились инфополя</span>
<a name="l00418"></a>00418  <span class="comment">// делается это путем "повторного" выбора текущего пункта</span>
<a name="l00419"></a>00419  <a class="code" href="classrecordtablescreen.html#55bc3b168d846297e2107ea29ee24f7a">select</a>(index);
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 <span class="comment">// Функция сохранения отредактированной записи в таблицу конечных записей</span>
<a name="l00424"></a><a class="code" href="classrecordtablescreen.html#41863650780dd07b0fc1275f748f78b4">00424</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#41863650780dd07b0fc1275f748f78b4">recordtablescreen::edit_field</a>(<span class="keywordtype">int</span> pos,
<a name="l00425"></a>00425                                    QString name,
<a name="l00426"></a>00426                                    QString author,
<a name="l00427"></a>00427                                    QString url,
<a name="l00428"></a>00428                                    QString tags)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430  qDebug() &lt;&lt; <span class="stringliteral">"In edit_field()"</span>;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432  <span class="comment">// Выясняется ссылка на таблицу конечных данных</span>
<a name="l00433"></a>00433  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *table=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e3a0df4eed2846f73e7858e27ce3fdb6">get_tabledata</a>();
<a name="l00434"></a>00434 
<a name="l00435"></a>00435  <span class="comment">// Обновление новых данных в таблице конечных записей</span>
<a name="l00436"></a>00436  table-&gt;<a class="code" href="classrecordtabledata.html#437205c90b9d57a3431b1677cef71c01">edit_record</a>(pos,
<a name="l00437"></a>00437                     name,
<a name="l00438"></a>00438                     author,
<a name="l00439"></a>00439                     url,
<a name="l00440"></a>00440                     tags);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442  <span class="comment">// Обновление инфополей в области редактирования записи</span>
<a name="l00443"></a>00443  <a class="code" href="classmetaeditor.html">metaeditor</a> *medt=find_object&lt;metaeditor&gt;(<span class="stringliteral">"editorview"</span>);
<a name="l00444"></a>00444  medt-&gt;<a class="code" href="classmetaeditor.html#209a7a5bd42af050a9fb55c6c8948ce4">set_name</a>(name);
<a name="l00445"></a>00445  medt-&gt;<a class="code" href="classmetaeditor.html#4703d66561c6c4e45d356a107b435124">set_author</a>(author);
<a name="l00446"></a>00446  medt-&gt;<a class="code" href="classmetaeditor.html#02edd9b23f915125e2b07fb5c6b4dbc7">set_url</a>(url);
<a name="l00447"></a>00447  medt-&gt;<a class="code" href="classmetaeditor.html#edf5c4b69e3a2fb3b6dbf6d629fd11ff">set_tags</a>(tags);
<a name="l00448"></a>00448  
<a name="l00449"></a>00449  <span class="comment">// Сохранение дерева веток</span>
<a name="l00450"></a>00450  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;save_knowtree();
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 
<a name="l00454"></a><a class="code" href="classrecordtablescreen.html#7112dde2ef63a21504b91061c6facd88">00454</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#7112dde2ef63a21504b91061c6facd88">recordtablescreen::delete_context</a>(<span class="keywordtype">void</span>)
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456  <span class="comment">// Создается окно с вопросом нужно удалять запись (записи) или нет</span>
<a name="l00457"></a>00457  QMessageBox messageBox(<span class="keyword">this</span>);
<a name="l00458"></a>00458  messageBox.setWindowTitle(<span class="stringliteral">"Delete"</span>);
<a name="l00459"></a>00459  messageBox.setText(<span class="stringliteral">"Are you sure to delete this record(s)?"</span>);
<a name="l00460"></a>00460  QAbstractButton *cancelButton =messageBox.addButton(tr(<span class="stringliteral">"Cancel"</span>), QMessageBox::RejectRole);
<a name="l00461"></a>00461  QAbstractButton *deleteButton =messageBox.addButton(tr(<span class="stringliteral">"Delete"</span>), QMessageBox::AcceptRole);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463  Q_UNUSED(cancelButton);
<a name="l00464"></a>00464  
<a name="l00465"></a>00465  messageBox.exec();
<a name="l00466"></a>00466  <span class="keywordflow">if</span> (messageBox.clickedButton() == deleteButton)
<a name="l00467"></a>00467   {
<a name="l00468"></a>00468    <span class="comment">// Выбранные данные удаляются</span>
<a name="l00469"></a>00469    <a class="code" href="classrecordtablescreen.html#91d1bc4b540ad9af78437a59143e94a4">delete_records</a>();
<a name="l00470"></a>00470   }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 <span class="comment">// Удаление отмеченных записей</span>
<a name="l00476"></a><a class="code" href="classrecordtablescreen.html#91d1bc4b540ad9af78437a59143e94a4">00476</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#91d1bc4b540ad9af78437a59143e94a4">recordtablescreen::delete_records</a>(<span class="keywordtype">void</span>)
<a name="l00477"></a>00477 {
<a name="l00478"></a>00478  <span class="comment">// Запоминание позиции, на которой стоит курсор списка</span>
<a name="l00479"></a>00479  <span class="keywordtype">int</span> before_index=(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;currentIndex()).row();
<a name="l00480"></a>00480 
<a name="l00481"></a>00481  <span class="comment">// Выясняется ссылка на таблицу конечных данных</span>
<a name="l00482"></a>00482  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *table=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e3a0df4eed2846f73e7858e27ce3fdb6">get_tabledata</a>();
<a name="l00483"></a>00483  
<a name="l00484"></a>00484  <span class="comment">// Получение списка Item-элементов, подлежащих удалению</span>
<a name="l00485"></a>00485  QModelIndexList itemsfordelete=<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00486"></a>00486 
<a name="l00487"></a>00487  <span class="comment">// Сбор в массив всех индексов, которые нужно удалить</span>
<a name="l00488"></a>00488  <span class="comment">// Напрямую пробегать массив item-элементов и удалять из него нельзя</span>
<a name="l00489"></a>00489  <span class="comment">// так как итератор начинает указывать на несуществующие элементы</span>
<a name="l00490"></a>00490  QVector&lt;int&gt; delidx;
<a name="l00491"></a>00491  QModelIndexList::iterator it;
<a name="l00492"></a>00492  <span class="keywordflow">for</span>(it=itemsfordelete.begin(); it!=itemsfordelete.end(); it++)
<a name="l00493"></a>00493  {
<a name="l00494"></a>00494   QModelIndex curridx;
<a name="l00495"></a>00495   curridx=*it;
<a name="l00496"></a>00496   qDebug() &lt;&lt; <span class="stringliteral">"Mark for delete item num "</span> &lt;&lt; curridx.row();
<a name="l00497"></a>00497   delidx.append( curridx.row() );
<a name="l00498"></a>00498  }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500  <span class="comment">// Массив удаляемых индексов сортируется так чтоб вначале </span>
<a name="l00501"></a>00501  <span class="comment">// были индексы с наименьшим номером</span>
<a name="l00502"></a>00502  qSort(delidx.begin(), delidx.end(), qLess&lt;int&gt;());
<a name="l00503"></a>00503  
<a name="l00504"></a>00504  <span class="comment">// Поиск индекса, на который надо установить засветку после удаления</span>
<a name="l00505"></a>00505  <span class="keywordtype">int</span> i=0,selection_index=-1;
<a name="l00506"></a>00506  <span class="keywordflow">for</span>(i=0;i&lt;table-&gt;<a class="code" href="classrecordtabledata.html#550a266ba595511d23216feb085853a9">size</a>();i++)
<a name="l00507"></a>00507   {
<a name="l00508"></a>00508    <span class="comment">// Если позиция не помечена на удаление, она считается</span>
<a name="l00509"></a>00509    <span class="keywordflow">if</span>(!delidx.contains(i))
<a name="l00510"></a>00510     {
<a name="l00511"></a>00511      selection_index++;
<a name="l00512"></a>00512   
<a name="l00513"></a>00513      <span class="comment">// На первой непомеченной после курсора позиции обработка прекращается</span>
<a name="l00514"></a>00514      <span class="comment">// Значение selection_index в этот момент и есть нужный индекс</span>
<a name="l00515"></a>00515      <span class="keywordflow">if</span>(i&gt;before_index)<span class="keywordflow">break</span>; 
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517   }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519  <span class="comment">// Вызывается удаление отмеченных записей</span>
<a name="l00520"></a>00520  table-&gt;<a class="code" href="classrecordtabledata.html#70252d36c2700c65a072d4c1290d2d52">delete_records</a>(delidx);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522  <span class="comment">// Сохранение дерева веток</span>
<a name="l00523"></a>00523  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;save_knowtree();
<a name="l00524"></a>00524 
<a name="l00525"></a>00525  <span class="comment">// Обновление на экране ветки, на которой стоит засветка,</span>
<a name="l00526"></a>00526  <span class="comment">// так как количество хранимых в ветке записей поменялось</span>
<a name="l00527"></a>00527  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;update_selected_branch();
<a name="l00528"></a>00528  
<a name="l00529"></a>00529  <span class="comment">// Обновление данных на экране для таблицы конечных записей</span>
<a name="l00530"></a>00530  <a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e19a2f856cd1dda4f1955af3544ce482">update</a>();
<a name="l00531"></a>00531  
<a name="l00532"></a>00532  <span class="comment">// Установка курсора на нужную позицию</span>
<a name="l00533"></a>00533  <span class="keywordflow">if</span>(selection_index&gt;=0)
<a name="l00534"></a>00534   {
<a name="l00535"></a>00535    <span class="comment">// Создание индекса из номера</span>
<a name="l00536"></a>00536    QModelIndex selidx=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;index(selection_index); 
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    <span class="comment">// Установка курсора</span>
<a name="l00539"></a>00539    <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;setCurrentIndex(selidx,QItemSelectionModel::ClearAndSelect);
<a name="l00540"></a>00540   }
<a name="l00541"></a>00541  <span class="keywordflow">else</span>
<a name="l00542"></a>00542   {
<a name="l00543"></a>00543    <span class="comment">// Иначе таблица конечных записей пуста, курсор устанавливать ненужно</span>
<a name="l00544"></a>00544 
<a name="l00545"></a>00545    <span class="comment">// Нужно очистить поле редактирования чтобы невидно было текста</span>
<a name="l00546"></a>00546    <span class="comment">// последней удаленной записи</span>
<a name="l00547"></a>00547    find_object&lt;metaeditor&gt;(<span class="stringliteral">"editorview"</span>)-&gt;clear_all();
<a name="l00548"></a>00548   }
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="comment">// Копирование отмеченных записей в буфер обмена с удалением </span>
<a name="l00553"></a>00553 <span class="comment">// из таблицы конечных записей</span>
<a name="l00554"></a><a class="code" href="classrecordtablescreen.html#ff66fb349cc313a39b880a6a24d3a48f">00554</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#ff66fb349cc313a39b880a6a24d3a48f">recordtablescreen::cut</a>(<span class="keywordtype">void</span>)
<a name="l00555"></a>00555 {
<a name="l00556"></a>00556  <a class="code" href="classrecordtablescreen.html#b955b96193163a47680f3331c65a80e9">copy</a>();
<a name="l00557"></a>00557  <a class="code" href="classrecordtablescreen.html#91d1bc4b540ad9af78437a59143e94a4">delete_records</a>();
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="comment">// Копирование отмеченных записей в буфер обмена</span>
<a name="l00561"></a><a class="code" href="classrecordtablescreen.html#b955b96193163a47680f3331c65a80e9">00561</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#b955b96193163a47680f3331c65a80e9">recordtablescreen::copy</a>(<span class="keywordtype">void</span>)
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563  <span class="comment">// Получение списка Item-элементов, подлежащих копированию</span>
<a name="l00564"></a>00564  QModelIndexList itemsforcopy=<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <span class="comment">// Создается ссылка на буфер обмена</span>
<a name="l00567"></a>00567  QClipboard *cbuf=QApplication::clipboard();
<a name="l00568"></a>00568 
<a name="l00569"></a>00569  <span class="comment">// Создается объект с данными для заполнения буфера обмена</span>
<a name="l00570"></a>00570  <span class="keyword">static</span> <span class="keywordtype">int</span> fillflag=0;
<a name="l00571"></a>00571  <span class="keywordflow">if</span>(fillflag==1)
<a name="l00572"></a>00572   {
<a name="l00573"></a>00573    <span class="keyword">const</span> <a class="code" href="classclipbrecords.html">clipbrecords</a> *rcd_previos;
<a name="l00574"></a>00574    rcd_previos=qobject_cast&lt;const clipbrecords *&gt;(cbuf-&gt;mimeData());
<a name="l00575"></a>00575    <span class="keywordflow">if</span>(rcd_previos!=NULL)<span class="keyword">delete</span> rcd_previos;
<a name="l00576"></a>00576    fillflag=0;
<a name="l00577"></a>00577   } 
<a name="l00578"></a>00578  <a class="code" href="classclipbrecords.html">clipbrecords</a> *rcd=<span class="keyword">new</span> <a class="code" href="classclipbrecords.html">clipbrecords</a>();
<a name="l00579"></a>00579  fillflag=1;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581  <span class="comment">// Выясняется ссылка на таблицу конечных данных</span>
<a name="l00582"></a>00582  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *table=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e3a0df4eed2846f73e7858e27ce3fdb6">get_tabledata</a>();
<a name="l00583"></a>00583 
<a name="l00584"></a>00584  <span class="comment">// Перебираются записи и вносятся в буфер обмена</span>
<a name="l00585"></a>00585  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;itemsforcopy.size(); ++i) 
<a name="l00586"></a>00586   rcd-&gt;<a class="code" href="classclipbrecords.html#6321842c1409b39eaa0433b7e01845bb">add_record</a>( table-&gt;<a class="code" href="classrecordtabledata.html#8483238f577c62c4d3a8467acda1636d">get_record_img</a>( (itemsforcopy.at(i)).row() ));
<a name="l00587"></a>00587 
<a name="l00588"></a>00588  <span class="comment">// Печатается содержимое буфера в консоль</span>
<a name="l00589"></a>00589  rcd-&gt;<a class="code" href="classclipbrecords.html#52fd489523b450d941fc81655bb80bdc">print</a>();
<a name="l00590"></a>00590 
<a name="l00591"></a>00591  <span class="comment">// Объект с записями помещается в буфер обмена</span>
<a name="l00592"></a>00592  cbuf-&gt;setMimeData(rcd);
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 
<a name="l00596"></a>00596 <span class="comment">// Вставка записей из буфера обмена</span>
<a name="l00597"></a><a class="code" href="classrecordtablescreen.html#247769a42808ec37995b4609d7c1750e">00597</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#247769a42808ec37995b4609d7c1750e">recordtablescreen::paste</a>(<span class="keywordtype">void</span>)
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599  <span class="comment">// Проверяется, содержит ли буфер обмена данные нужного формата</span>
<a name="l00600"></a>00600  <span class="keywordflow">if</span>(!(QApplication::clipboard()-&gt;mimeData()-&gt;hasFormat(<span class="stringliteral">"mytetra/records"</span>))) 
<a name="l00601"></a>00601   <span class="keywordflow">return</span>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603  <span class="comment">// Создается ссылка на буфер обмена</span>
<a name="l00604"></a>00604  QClipboard *cbuf=QApplication::clipboard();
<a name="l00605"></a>00605  
<a name="l00606"></a>00606  <span class="comment">// Извлечение объекта из буфера обмена</span>
<a name="l00607"></a>00607  <span class="comment">// const clipbrecords *rcd=new clipbrecords();</span>
<a name="l00608"></a>00608  <span class="keyword">const</span> <a class="code" href="classclipbrecords.html">clipbrecords</a> *rcd;
<a name="l00609"></a>00609  rcd=qobject_cast&lt;const clipbrecords *&gt;(cbuf-&gt;mimeData());
<a name="l00610"></a>00610  rcd-&gt;<a class="code" href="classclipbrecords.html#52fd489523b450d941fc81655bb80bdc">print</a>();
<a name="l00611"></a>00611 
<a name="l00612"></a>00612  <span class="comment">// Выясняется количество записей в буфере</span>
<a name="l00613"></a>00613  <span class="keywordtype">int</span> nlist=rcd-&gt;<a class="code" href="classclipbrecords.html#bb594290bb70e0dc9d66237ed272e173">get_records_num</a>();
<a name="l00614"></a>00614  
<a name="l00615"></a>00615  <span class="comment">// Пробегаются все записи в буфере</span>
<a name="l00616"></a>00616  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;nlist;i++)
<a name="l00617"></a>00617   {
<a name="l00618"></a>00618    QMap&lt;QString, QString&gt; curr_record;
<a name="l00619"></a>00619    
<a name="l00620"></a>00620    <span class="comment">// Получение из буфера записи с нужным номером</span>
<a name="l00621"></a>00621    curr_record=rcd-&gt;<a class="code" href="classclipbrecords.html#539c2263d9314dc24cd47b833bbcac8a">get_record</a>(i);
<a name="l00622"></a>00622  
<a name="l00623"></a>00623    <span class="comment">// if(recordview-&gt;selectionModel()-&gt;hasSelection())</span>
<a name="l00624"></a>00624  
<a name="l00625"></a>00625    <a class="code" href="classrecordtablescreen.html#e3e3b5770bfdb550262ff4dab723599a">add_new</a>(<a class="code" href="mainwindow_8h.html#3ff28b5932200d5e6cac920029f0df0d">ADD_NEW_RECORD_TO_END</a>,
<a name="l00626"></a>00626            curr_record[<span class="stringliteral">"name"</span>],
<a name="l00627"></a>00627            curr_record[<span class="stringliteral">"author"</span>],
<a name="l00628"></a>00628            curr_record[<span class="stringliteral">"url"</span>],
<a name="l00629"></a>00629            curr_record[<span class="stringliteral">"tags"</span>],
<a name="l00630"></a>00630            curr_record[<span class="stringliteral">"text"</span>]);
<a name="l00631"></a>00631   }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633  <span class="comment">// Обновление на экране ветки, на которой стоит засветка,</span>
<a name="l00634"></a>00634  <span class="comment">// так как количество хранимых в ветке записей поменялось</span>
<a name="l00635"></a>00635  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;update_selected_branch();
<a name="l00636"></a>00636 }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 <span class="comment">// Отключение всех действий</span>
<a name="l00640"></a><a class="code" href="classrecordtablescreen.html#29e17faab1f97b595f897d80c287f92d">00640</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#29e17faab1f97b595f897d80c287f92d">recordtablescreen::disable_all_actions</a>(<span class="keywordtype">void</span>)
<a name="l00641"></a>00641 {
<a name="l00642"></a>00642  <a class="code" href="classrecordtablescreen.html#755c98554622673eb9f70c0dff10074b">action_add_new_toend</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00643"></a>00643  <a class="code" href="classrecordtablescreen.html#6199377c78472f1c21b8ff6069f72c61">action_add_new_before</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00644"></a>00644  <a class="code" href="classrecordtablescreen.html#350b6410856141258b1d324686e26b09">action_add_new_after</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00645"></a>00645  <a class="code" href="classrecordtablescreen.html#3cbd66091b8a77cfa75ca9b61edc9f6f">action_edit_field</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00646"></a>00646  <a class="code" href="classrecordtablescreen.html#fd4cb6265dd10d559f8d0244043dae42">action_delete</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648  <a class="code" href="classrecordtablescreen.html#7c31f0fce3ad60ad8117b6954f9bd875">action_cut</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00649"></a>00649  <a class="code" href="classrecordtablescreen.html#7490f795a1262cf53d1f1e6455de0100">action_copy</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00650"></a>00650  <a class="code" href="classrecordtablescreen.html#4a5328fc69bfc95fd33635bdd190da4a">action_paste</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652  <a class="code" href="classrecordtablescreen.html#30cf00f9d33ba2dba680f9674abe5671">action_moveup</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00653"></a>00653  <a class="code" href="classrecordtablescreen.html#ccdcdeffdc381b2bdf2d8f550816d4ac">action_movedn</a>-&gt;setEnabled(<span class="keyword">false</span>);
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 
<a name="l00657"></a><a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">00657</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#a4b0a512d0caf52495f5cb2883fcb2f8">recordtablescreen::tools_update</a>(<span class="keywordtype">void</span>)
<a name="l00658"></a>00658 {
<a name="l00659"></a>00659  qDebug() &lt;&lt; <span class="stringliteral">"Recordtable tools update"</span>;
<a name="l00660"></a>00660 
<a name="l00661"></a>00661  <span class="comment">// Отключаются все действия</span>
<a name="l00662"></a>00662  <a class="code" href="classrecordtablescreen.html#29e17faab1f97b595f897d80c287f92d">disable_all_actions</a>();
<a name="l00663"></a>00663 
<a name="l00664"></a>00664  <span class="comment">// Выясняется, содержит ли текущая ветка подчиненные ветки</span>
<a name="l00665"></a>00665  <span class="comment">/*</span>
<a name="l00666"></a>00666 <span class="comment"> QModelIndex index = find_object&lt;treescreen&gt;("treeview")-&gt;get_selection_model()-&gt;currentIndex();</span>
<a name="l00667"></a>00667 <span class="comment"> TreeItem *item = find_object&lt;treescreen&gt;("treeview")-&gt;kntrmodel-&gt;getItem(index);</span>
<a name="l00668"></a>00668 <span class="comment"> int branch_have_children=0;</span>
<a name="l00669"></a>00669 <span class="comment"> if(item-&gt;childCount()&gt;0)branch_have_children=1;</span>
<a name="l00670"></a>00670 <span class="comment"> */</span>
<a name="l00671"></a>00671 
<a name="l00672"></a>00672  <span class="comment">// Включаются те действия которые разрешены</span>
<a name="l00673"></a>00673 
<a name="l00674"></a>00674  <span class="comment">// Добавление записи</span>
<a name="l00675"></a>00675  <span class="comment">// Добавлять можно к любой ветке</span>
<a name="l00676"></a>00676  <a class="code" href="classrecordtablescreen.html#755c98554622673eb9f70c0dff10074b">action_add_new_toend</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678  <span class="comment">// Добавление записи до</span>
<a name="l00679"></a>00679  <span class="comment">// Добавлять "до" можно только тогда, когда выбрана только одна строка</span>
<a name="l00680"></a>00680  <span class="keywordflow">if</span>((<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection() &amp;&amp;
<a name="l00681"></a>00681      (<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedRows()).size()==1))
<a name="l00682"></a>00682     <a class="code" href="classrecordtablescreen.html#6199377c78472f1c21b8ff6069f72c61">action_add_new_before</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684  <span class="comment">// Добавление записи после</span>
<a name="l00685"></a>00685  <span class="comment">// Добавлять "после" можно только тогда, когда выбрана только одна строка</span>
<a name="l00686"></a>00686  <span class="keywordflow">if</span>((<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection() &amp;&amp;
<a name="l00687"></a>00687      (<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedRows()).size()==1))
<a name="l00688"></a>00688   <a class="code" href="classrecordtablescreen.html#350b6410856141258b1d324686e26b09">action_add_new_after</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00689"></a>00689 
<a name="l00690"></a>00690  <span class="comment">// Редактирование записи</span>
<a name="l00691"></a>00691  <span class="comment">// Редактировать можно только тогда, когда выбрана только одна строка</span>
<a name="l00692"></a>00692  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection() &amp;&amp;
<a name="l00693"></a>00693     (<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedRows()).size()==1)
<a name="l00694"></a>00694   <a class="code" href="classrecordtablescreen.html#3cbd66091b8a77cfa75ca9b61edc9f6f">action_edit_field</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696  <span class="comment">// Удаление записи</span>
<a name="l00697"></a>00697  <span class="comment">// Пункт активен только если запись (или записи) выбраны в списке</span>
<a name="l00698"></a>00698  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection())
<a name="l00699"></a>00699   <a class="code" href="classrecordtablescreen.html#fd4cb6265dd10d559f8d0244043dae42">action_delete</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701  <span class="comment">// Удаление с копированием записи в буфер обмена</span>
<a name="l00702"></a>00702  <span class="comment">// Пункт активен только если запись (или записи) выбраны в списке</span>
<a name="l00703"></a>00703  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection())
<a name="l00704"></a>00704   <a class="code" href="classrecordtablescreen.html#7c31f0fce3ad60ad8117b6954f9bd875">action_cut</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00705"></a>00705 
<a name="l00706"></a>00706  <span class="comment">// Копирование записи в буфер обмена</span>
<a name="l00707"></a>00707  <span class="comment">// Пункт активен только если запись (или записи) выбраны в списке</span>
<a name="l00708"></a>00708  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection())
<a name="l00709"></a>00709   <a class="code" href="classrecordtablescreen.html#7490f795a1262cf53d1f1e6455de0100">action_copy</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711  <span class="comment">// Вставка записи из буфера обмена</span>
<a name="l00712"></a>00712  <span class="comment">// Вставлять записи можно только тогда, когда выбрана</span>
<a name="l00713"></a>00713  <span class="comment">// только одна строка (добавляется после выделеной строки)</span>
<a name="l00714"></a>00714  <span class="comment">// или не выбрано ни одной строки (тогда добавляется в конец списка)</span>
<a name="l00715"></a>00715  <span class="comment">// или записей вообще нет</span>
<a name="l00716"></a>00716  <span class="comment">// И проверяется, содержит ли буфер обмена данные нужного формата</span>
<a name="l00717"></a>00717  <span class="keywordflow">if</span>((<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection() &amp;&amp; (<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedRows()).size()==1) ||
<a name="l00718"></a>00718      <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection()==<span class="keyword">false</span> ||
<a name="l00719"></a>00719      <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;model()-&gt;rowCount()==0)
<a name="l00720"></a>00720   <span class="keywordflow">if</span>(QApplication::clipboard()-&gt;mimeData()-&gt;hasFormat(<span class="stringliteral">"mytetra/records"</span>)) 
<a name="l00721"></a>00721    <a class="code" href="classrecordtablescreen.html#4a5328fc69bfc95fd33635bdd190da4a">action_paste</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00722"></a>00722 
<a name="l00723"></a>00723  <span class="comment">// Перемещение записи вверх</span>
<a name="l00724"></a>00724  <span class="comment">// Пункт возможен только когда выбрана одна строка</span>
<a name="l00725"></a>00725  <span class="comment">// и указатель стоит не на начале списка</span>
<a name="l00726"></a>00726  <span class="keywordflow">if</span>((<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection() &amp;&amp; (<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedRows()).size()==1) &amp;&amp;
<a name="l00727"></a>00727     <a class="code" href="classrecordtablescreen.html#c84c840f480e4e03017e4f3056388d3d">is_selected_set_to_top</a>()==false )
<a name="l00728"></a>00728   <a class="code" href="classrecordtablescreen.html#30cf00f9d33ba2dba680f9674abe5671">action_moveup</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730  <span class="comment">// Перемещение записи вниз</span>
<a name="l00731"></a>00731  <span class="comment">// Пункт возможен только когда выбрана одна строка</span>
<a name="l00732"></a>00732  <span class="comment">// и указатель стоит не в конце списка</span>
<a name="l00733"></a>00733  <span class="keywordflow">if</span>((<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection() &amp;&amp; (<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedRows()).size()==1) &amp;&amp;
<a name="l00734"></a>00734     <a class="code" href="classrecordtablescreen.html#c73f9f801e76c4cb83556dd1b99d8192">is_selected_set_to_bottom</a>()==false )
<a name="l00735"></a>00735   <a class="code" href="classrecordtablescreen.html#ccdcdeffdc381b2bdf2d8f550816d4ac">action_movedn</a>-&gt;setEnabled(<span class="keyword">true</span>);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737  <span class="comment">// Обновляется состояние области редактирования текста</span>
<a name="l00738"></a>00738  <span class="comment">// если ни одна запись не выбрана, редактирование невозможно</span>
<a name="l00739"></a>00739  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;hasSelection())
<a name="l00740"></a>00740   find_object&lt;metaeditor&gt;(<span class="stringliteral">"editorview"</span>)-&gt;set_textarea_editable(<span class="keyword">true</span>);
<a name="l00741"></a>00741  <span class="keywordflow">else</span>
<a name="l00742"></a>00742   find_object&lt;metaeditor&gt;(<span class="stringliteral">"editorview"</span>)-&gt;set_textarea_editable(<span class="keyword">false</span>);
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 <span class="comment">// Открытие контекстного меню в таблице конечных записей</span>
<a name="l00747"></a><a class="code" href="classrecordtablescreen.html#4d456453a98a1cda55cf374d4178f6a8">00747</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#4d456453a98a1cda55cf374d4178f6a8">recordtablescreen::on_customContextMenuRequested</a>(<span class="keyword">const</span> QPoint &amp;pos)
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749   qDebug(<span class="stringliteral">"In on_customContextMenuRequested"</span>);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751   <span class="comment">// Конструирование меню</span>
<a name="l00752"></a>00752   QMenu menu(<span class="keyword">this</span>);
<a name="l00753"></a>00753   menu.addAction(<a class="code" href="classrecordtablescreen.html#755c98554622673eb9f70c0dff10074b">action_add_new_toend</a>);
<a name="l00754"></a>00754   menu.addAction(<a class="code" href="classrecordtablescreen.html#6199377c78472f1c21b8ff6069f72c61">action_add_new_before</a>);
<a name="l00755"></a>00755   menu.addAction(<a class="code" href="classrecordtablescreen.html#350b6410856141258b1d324686e26b09">action_add_new_after</a>);
<a name="l00756"></a>00756   menu.addSeparator();
<a name="l00757"></a>00757   menu.addAction(<a class="code" href="classrecordtablescreen.html#3cbd66091b8a77cfa75ca9b61edc9f6f">action_edit_field</a>);
<a name="l00758"></a>00758   menu.addAction(<a class="code" href="classrecordtablescreen.html#fd4cb6265dd10d559f8d0244043dae42">action_delete</a>);
<a name="l00759"></a>00759   menu.addSeparator();
<a name="l00760"></a>00760   menu.addAction(<a class="code" href="classrecordtablescreen.html#7c31f0fce3ad60ad8117b6954f9bd875">action_cut</a>);
<a name="l00761"></a>00761   menu.addAction(<a class="code" href="classrecordtablescreen.html#7490f795a1262cf53d1f1e6455de0100">action_copy</a>);
<a name="l00762"></a>00762   menu.addAction(<a class="code" href="classrecordtablescreen.html#4a5328fc69bfc95fd33635bdd190da4a">action_paste</a>);
<a name="l00763"></a>00763  
<a name="l00764"></a>00764   <span class="comment">// Включение отображения меню на экране</span>
<a name="l00765"></a>00765   <span class="comment">// menu.exec(event-&gt;globalPos());</span>
<a name="l00766"></a>00766   menu.exec(<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;viewport()-&gt;mapToGlobal(pos));
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 
<a name="l00770"></a>00770 <span class="comment">// Перемещение записи вверх</span>
<a name="l00771"></a><a class="code" href="classrecordtablescreen.html#732e2c379f2a1149023965f1c62fab05">00771</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#732e2c379f2a1149023965f1c62fab05">recordtablescreen::moveup</a>(<span class="keywordtype">void</span>)
<a name="l00772"></a>00772 {
<a name="l00773"></a>00773  qDebug() &lt;&lt; <span class="stringliteral">"In moveup()"</span>;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775  <span class="comment">// Получение номера первой выделенной строки</span>
<a name="l00776"></a>00776  <span class="keywordtype">int</span> pos=<a class="code" href="classrecordtablescreen.html#edf8ac561d0f33acf6af0fe63fbc8a91">get_first_selection_pos</a>();
<a name="l00777"></a>00777 
<a name="l00778"></a>00778  <span class="comment">// Выясняется ссылка на таблицу конечных данных</span>
<a name="l00779"></a>00779  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *table=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e3a0df4eed2846f73e7858e27ce3fdb6">get_tabledata</a>();
<a name="l00780"></a>00780 
<a name="l00781"></a>00781  <span class="comment">// Перемещение текущей записи вверх</span>
<a name="l00782"></a>00782  table-&gt;<a class="code" href="classrecordtabledata.html#077ca508e4d7b39ff7890409650ef4d2">moveup</a>(pos);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784  <span class="comment">// Установка засветки на перемещенную запись</span>
<a name="l00785"></a>00785  <a class="code" href="classrecordtablescreen.html#3694df3f0aae7c3b1ea3913e81b94f90">set_selection_to_pos</a>(pos-1);
<a name="l00786"></a>00786 
<a name="l00787"></a>00787  <span class="comment">// Сохранение дерева веток</span>
<a name="l00788"></a>00788  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;save_knowtree();
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 }
<a name="l00791"></a>00791 
<a name="l00792"></a>00792 
<a name="l00793"></a>00793 <span class="comment">// Перемещение записи вниз</span>
<a name="l00794"></a><a class="code" href="classrecordtablescreen.html#fc3e465b3266eb01ee0a1f95839f7edd">00794</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#fc3e465b3266eb01ee0a1f95839f7edd">recordtablescreen::movedn</a>(<span class="keywordtype">void</span>)
<a name="l00795"></a>00795 {
<a name="l00796"></a>00796  qDebug() &lt;&lt; <span class="stringliteral">"In movedn()"</span>;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798  <span class="comment">// Получение номера первой выделенной строки</span>
<a name="l00799"></a>00799  <span class="keywordtype">int</span> pos=<a class="code" href="classrecordtablescreen.html#edf8ac561d0f33acf6af0fe63fbc8a91">get_first_selection_pos</a>();
<a name="l00800"></a>00800 
<a name="l00801"></a>00801  <span class="comment">// Выясняется ссылка на таблицу конечных данных</span>
<a name="l00802"></a>00802  <a class="code" href="classrecordtabledata.html">recordtabledata</a> *table=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;<a class="code" href="classrecordtablemodel.html#e3a0df4eed2846f73e7858e27ce3fdb6">get_tabledata</a>();
<a name="l00803"></a>00803 
<a name="l00804"></a>00804  <span class="comment">// Перемещение текущей записи вниз</span>
<a name="l00805"></a>00805  table-&gt;<a class="code" href="classrecordtabledata.html#ba8cc1322d315f7c7e310dff74d15053">movedn</a>(pos);
<a name="l00806"></a>00806 
<a name="l00807"></a>00807  <span class="comment">// Установка засветки на перемещенную запись</span>
<a name="l00808"></a>00808  <a class="code" href="classrecordtablescreen.html#3694df3f0aae7c3b1ea3913e81b94f90">set_selection_to_pos</a>(pos+1);
<a name="l00809"></a>00809 
<a name="l00810"></a>00810  <span class="comment">// Сохранение дерева веток</span>
<a name="l00811"></a>00811  find_object&lt;treescreen&gt;(<span class="stringliteral">"treeview"</span>)-&gt;save_knowtree();
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="comment">// Получение номера первого выделенного элемента</span>
<a name="l00817"></a><a class="code" href="classrecordtablescreen.html#edf8ac561d0f33acf6af0fe63fbc8a91">00817</a> <span class="keywordtype">int</span> <a class="code" href="classrecordtablescreen.html#edf8ac561d0f33acf6af0fe63fbc8a91">recordtablescreen::get_first_selection_pos</a>(<span class="keywordtype">void</span>)
<a name="l00818"></a>00818 {
<a name="l00819"></a>00819  <span class="comment">// Получение списка выделенных Item-элементов</span>
<a name="l00820"></a>00820  QModelIndexList selectitems=<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;selectedIndexes();
<a name="l00821"></a>00821 
<a name="l00822"></a>00822  <span class="keywordflow">if</span>(selectitems.isEmpty())
<a name="l00823"></a>00823   <span class="keywordflow">return</span> -1; <span class="comment">// Если ничего не выделено</span>
<a name="l00824"></a>00824  <span class="keywordflow">else</span>
<a name="l00825"></a>00825   <span class="keywordflow">return</span> (selectitems.at(0)).row(); <span class="comment">// Индекс первого выделенного элемента</span>
<a name="l00826"></a>00826 }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828 
<a name="l00829"></a><a class="code" href="classrecordtablescreen.html#c84c840f480e4e03017e4f3056388d3d">00829</a> <span class="keywordtype">bool</span> <a class="code" href="classrecordtablescreen.html#c84c840f480e4e03017e4f3056388d3d">recordtablescreen::is_selected_set_to_top</a>(<span class="keywordtype">void</span>)
<a name="l00830"></a>00830 {
<a name="l00831"></a>00831  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#edf8ac561d0f33acf6af0fe63fbc8a91">get_first_selection_pos</a>()==0)<span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00832"></a>00832  <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00833"></a>00833 }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 
<a name="l00836"></a><a class="code" href="classrecordtablescreen.html#c73f9f801e76c4cb83556dd1b99d8192">00836</a> <span class="keywordtype">bool</span> <a class="code" href="classrecordtablescreen.html#c73f9f801e76c4cb83556dd1b99d8192">recordtablescreen::is_selected_set_to_bottom</a>(<span class="keywordtype">void</span>)
<a name="l00837"></a>00837 {
<a name="l00838"></a>00838  <span class="keywordflow">if</span>(<a class="code" href="classrecordtablescreen.html#edf8ac561d0f33acf6af0fe63fbc8a91">get_first_selection_pos</a>()==<a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;model()-&gt;rowCount()-1)<span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00839"></a>00839  <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="comment">// Установка засветки в нужную строку</span>
<a name="l00844"></a><a class="code" href="classrecordtablescreen.html#3694df3f0aae7c3b1ea3913e81b94f90">00844</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#3694df3f0aae7c3b1ea3913e81b94f90">recordtablescreen::set_selection_to_pos</a>(<span class="keywordtype">int</span> pos)
<a name="l00845"></a>00845 {
<a name="l00846"></a>00846  <span class="comment">// Создание индекса из номера</span>
<a name="l00847"></a>00847  QModelIndex selidx=<a class="code" href="classrecordtablescreen.html#1806a1e7cad7c5037c19ec88f3859f95">recordmodel</a>-&gt;index(pos);
<a name="l00848"></a>00848 
<a name="l00849"></a>00849  <span class="comment">// Установка засветки на нужный индекс</span>
<a name="l00850"></a>00850  <a class="code" href="classrecordtablescreen.html#f155dacd499c3f6da2816da222683e87">recordview</a>-&gt;selectionModel()-&gt;setCurrentIndex(selidx,QItemSelectionModel::ClearAndSelect);
<a name="l00851"></a>00851 }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853 
<a name="l00854"></a>00854 <span class="comment">// Действия при нажатии на кнопку поиска по базе</span>
<a name="l00855"></a><a class="code" href="classrecordtablescreen.html#2b14a42da565396ee402c9cf1046c00c">00855</a> <span class="keywordtype">void</span> <a class="code" href="classrecordtablescreen.html#2b14a42da565396ee402c9cf1046c00c">recordtablescreen::findinbase_open</a>(<span class="keywordtype">void</span>)
<a name="l00856"></a>00856 {
<a name="l00857"></a>00857  <span class="comment">// Определяется ссылка на виджет поиска</span>
<a name="l00858"></a>00858  <a class="code" href="classfindscreen.html">findscreen</a> *findscreen_rel=find_object&lt;findscreen&gt;(<span class="stringliteral">"findscreendisp"</span>);
<a name="l00859"></a>00859  
<a name="l00860"></a>00860  <span class="comment">// Если виджет не показан, он выводится на экран, и наоборот</span>
<a name="l00861"></a>00861  <span class="keywordflow">if</span>(findscreen_rel-&gt;isVisible()==<span class="keyword">false</span>)
<a name="l00862"></a>00862   findscreen_rel-&gt;<a class="code" href="classfindscreen.html#90ec8cf049de60964e6f0037f8bb9eb4">widget_show</a>();
<a name="l00863"></a>00863  <span class="keywordflow">else</span>
<a name="l00864"></a>00864   findscreen_rel-&gt;<a class="code" href="classfindscreen.html#42187bda0c53a3dbc227da053ce000de">widget_hide</a>();
<a name="l00865"></a>00865 }
<a name="l00866"></a>00866 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Feb 2 00:25:34 2009 for mytetra by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1 </small></address>
</body>
</html>
